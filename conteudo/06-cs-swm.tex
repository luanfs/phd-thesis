\chapter{Cubed-sphere finite-volume shallow-water model}
\label{chp-cs-swm}

Even though the advection equation on the sphere plays a key role in the dynamical core development,
since it models the advection of scalar fields on the sphere, important features captured by the shallow-water
equations on the sphere, such as the Coriolis effect, inertia-gravity waves, geostrophic adjustment, Rossby waves,
among others, are not captured by a simple advection model.
Hence, shallow-water equations provide an excellent benchmark to assess dynamical cores in general,
since it is only two-dimensional but is a complex enough geophysical model for atmosphere dynamics.
\newpage
\section{The shallow-water equations on the sphere}
\label{sec:sweq}
The shallow-water are expressed as:
\begin{align}
	\label{2d-sweq-h}
	{\partial_t (\sqrt{\mathfrak{g}} {h})}(x, y, t) &= -
	[{\partial_x (\mathfrak{u}\sqrt{\mathfrak{g}}{h}}
	+ {\partial_y (\mathfrak{v}\sqrt{\mathfrak{g}}{h})}](x, y, t), \\
	\label{2d-sweq-u}
	{\partial_t \mathfrak{U}}(x, y, t)&=
	-[\partial_x K - \mathfrak{v}\sqrt{\mathfrak{g}}\xi +\partial_x \Phi] (x, y, t), \\
	\label{2d-sweq-v}
	{\partial_t \mathfrak{V}}(x, y, t)&=
	-[\partial_y K + \mathfrak{u}\sqrt{\mathfrak{g}}\xi + \partial_y \Phi](x, y, t), 
\end{align}
$\Phi = g(h+b)$ is the geopotential, $g$ is the gravity, $b$ is the bottom topography,
\begin{equation}
	\label{ke-eq}
	K = \frac{\mathfrak{u}\mathfrak{U}+\mathfrak{v}\mathfrak{V}}{2},
\end{equation}
is the kinetic energy,
\begin{equation}
	\label{vort-eq}
	\xi = f+ \zeta,
\end{equation}
is the relative vorticity, where
\begin{equation}
	\label{coriolis-eq}
	f  = 2 \Omega \sin{\phi},
\end{equation}
is the Coriolis parameter,
$\phi$ is the latitude, $\Omega = 7.2921 \times 10^{-5}$ is the earth rotation speed, and
\begin{equation}
	\label{vort2-eq}
	\zeta = \frac{1}{\sqrt{\mathfrak{g}}}(\partial_x \mathfrak{V} - \partial_y\mathfrak{U}),
\end{equation}
is the relative vorticity.
By taking $\partial_y$ in Equation \eqref{2d-sweq-u} and $\partial_x$ in Equation \eqref{2d-sweq-v} and
subtracting the obtained results, we get that the relative vorticity satisfies:
\begin{align}
	\label{absvort-eq}
	{\partial_t (\sqrt{\mathfrak{g}} {\zeta})}(x,y,t) & = 
	-[{\partial_x (\mathfrak{u}\sqrt{\mathfrak{g}}{\zeta}})
	+ {\partial_y (\mathfrak{v}\sqrt{\mathfrak{g}}{\zeta}})](x,y,t).
\end{align}
By replacing Equations \eqref{contra-uv} and \eqref{covari-uv} in Equation \ref{ke-eq}, 
it follows that the kinetic energy may be rewritten in terms of the normalized contravariant and covariant components as:
\begin{equation}
	\label{ke-eq2}
	K = \frac{{u}{U}+{v}{V}}{2}.
\end{equation}

\newpage

\subsection{Momentum equation discretization}
The continuity Equation \eqref{2d-sweq-h} has the exact form as the advection equation when written in its conservative form.
Then, this equation can be solved on the A-grid using C-grid winds,
as explored in Chapters \ref{chp-2d-fv} and \ref{chp-cs-fv}.
This is how the continuity equation is solved in FV3.
As we shall see later, this equation is solved using the 2D upwind flux and the dimension-splitting method from Chapter \ref{chp-cs-fv} with PPM.
Therefore, we need to describe how we can solve the momentum equations \eqref{2d-sweq-u} and \eqref{2d-sweq-v}. 
The method of \citet{lin:1997} employs two types of approaches on their shallow-water solver: one using a C-grid wind and the other using a D-grid.
The C-grid method serves as an intermediate step utilized by the D-grid method.

\subsection{D-grid discretization of momentum equation }
We introduce the following average operators for the covariant components in $x$ and $y$ directions, respectively:
\begin{align}
	\label{2d-sweq-int_u}
	\overline{\mathfrak{U}^x_{i,j+\frac{1}{2}}}(t)&= \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \mathfrak{U}(x, y_{j+\frac{1}{2}}, t) \,dx , \quad i=1,\ldots,N,j=0,\ldots, N,\\
	\label{2d-sweq-int_v}
	\overline{\mathfrak{V}^y_{i+\frac{1}{2},j}}(t)&= \frac{1}{\Delta y} \int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}} \mathfrak{V}(x_{i+\frac{1}{2}}, y, t) \,dy,  \quad i=0,\ldots,N,j=1,\ldots, N.
\end{align}
By integrating Equation \eqref{2d-sweq-u} with respect to $x$ on $[x_{i-\frac{1}{2}},x_{i+\frac{1}{2}}]$ and Equation \eqref{2d-sweq-v} with respect to $y$ on $[y_{j-\frac{1}{2}},y_{j+\frac{1}{2}}]$, we get the following equations:
\begin{align}
	\label{2d-sweq-int_equ}
	\frac{d}{dt}\overline{\mathfrak{U}^x_{i,j+\frac{1}{2}}}
	(t)&= -\frac{\delta_x K(x_i,y_{j+\frac{1}{2}},t)}{\Delta x}-\frac{\delta_x \Phi(x_i,y_{j+\frac{1}{2}},t)}{\Delta x} + 
	\frac{1}{\Delta x}
	\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}
	\mathfrak{v}\sqrt{\mathfrak{g}}\xi(x_i, y_{j+\frac{1}{2}}, t) \,dx, \\
	\label{2d-sweq-int_eqv}
	\frac{d}{dt} \overline{\mathfrak{V}^y_{i+\frac{1}{2},j}}(t)&= -\frac{\delta_y K(x_{i+\frac{1}{2}},y_j,t)}{\Delta y}-\frac{\delta_y
		\Phi(x_{i+\frac{1}{2}},y_{j},t)}{\Delta y}
	- \frac{1}{\Delta y}
	\int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}} 
	\mathfrak{u}\sqrt{\mathfrak{g}}\xi(x_{i+\frac{1}{2}},
	y_j, t) \,dy,
\end{align}
Integrating Equations \eqref{2d-sweq-int_equ} and \eqref{2d-sweq-int_eqv} on time over $[t^n,t^{n+1}]$, we obtain:
\begin{align}
	\label{2d-sweq-int_equt}
	\overline{\mathfrak{U}^x_{i,j+\frac{1}{2}}}(t^{n+1})&=
	\overline{\mathfrak{U}^x_{i,j+\frac{1}{2}}}(t^{n}) -\Delta t \bigg[\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}}\bigg(
	\frac{\delta_x K(x_i,y_{j+\frac{1}{2}},t)}{\Delta x}
	+\frac{\delta_x \Phi(x_i,y_{j+\frac{1}{2}},t)}{\Delta x} -
	\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}
	\frac{\mathfrak{v}\sqrt{\mathfrak{g}}\xi(x_i, y_{j+\frac{1}{2}}, t)}{\Delta x}
	\,dx \bigg)
	\,dt \bigg],\\
	\label{2d-sweq-int_eqvt}
	\overline{\mathfrak{V}^y_{i+\frac{1}{2},j}}(t^{n+1})&=
	\overline{\mathfrak{V}^y_{i+\frac{1}{2},j}}(t^{n}) -\Delta t \bigg[\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}}\bigg(
	\frac{\delta_y K(x_{i+\frac{1}{2}},y_j,t)}{\Delta y}+\frac{\delta_y
		\Phi(x_{i+\frac{1}{2}},y_j,t)}{\Delta y}
	+
	\int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}} 
	\frac{\mathfrak{u}\sqrt{\mathfrak{g}}\xi(x_{i+\frac{1}{2}}, y, t)}{\Delta y}
	\,dy \bigg)\,dt\bigg],
\end{align}
Using the midpoint rule and using the normalized covariant winds in Equations \eqref{2d-sweq-int_equt} and \eqref{2d-sweq-int_eqvt}, we derive a general scheme
to update the normalized covariant D-grid winds:
\begin{align}
	\label{2d-sweq-dscheme-u}
	{U}_{i,j+\frac{1}{2}}^{n+1}&=
	{U}_{i,j+\frac{1}{2}}^{n} -\Delta t \bigg[
	\frac{\delta_i K_{i,j+\frac{1}{2}}^n}{\hat{\delta} x_{i,j+\frac{1}{2}}}
	+\frac{\delta_i \Phi_{i,j+\frac{1}{2}}^n}{\hat{\delta} x_{i,j+\frac{1}{2}}} -
	\frac{1}{\Delta t}
	\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}
	\frac{\mathfrak{v}\sqrt{\mathfrak{g}}\xi(x_i, y_{j+\frac{1}{2}}, t)}{\Delta x}
	\,dx \bigg)
	\,dt \bigg],\\
	\label{2d-sweq-dscheme-v}
	{V}_{i+\frac{1}{2},j}^{n+1}&=
	{V}_{i+\frac{1}{2},j}^{n} -\Delta t \bigg[
	\frac{\delta_j K_{i+\frac{1}{2},j}}{\hat{\delta} y_{i+\frac{1}{2},j}}+
	\frac{\delta_j \Phi_{{i+\frac{1}{2}},j}^n}{\hat{\delta} y_{i+\frac{1}{2},j}}
	+
	\frac{1}{\Delta t}
	\int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}} 
	\frac{\mathfrak{u}\sqrt{\mathfrak{g}}\xi(x_{i+\frac{1}{2}}, y, t)}{\Delta y}
	\,dy \bigg)\,dt\bigg],
\end{align}
Then, this schemes requires an approximation of the time-averaged kinetic energy at the B-grid
\begin{equation}
	K_{i+\frac{1}{2},j+\frac{1}{2}}^n \approx \frac{1}{2}\bigg[
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} {u}{U}
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt +
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} {v}{V}
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt)\bigg],
\end{equation}
an approximation of the time-averaged geopotential on B-grid points:
\begin{equation}
	\Phi_{i+\frac{1}{2},j+\frac{1}{2}}^n \approx
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} \Phi
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt,
\end{equation}
and an approximation of the time-average vorticity fluxes
\begin{equation}
	\Phi_{i+\frac{1}{2},j+\frac{1}{2}}^n \approx
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} \Phi
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt.
\end{equation}
These approximations are described in Section \ref{csw-grid}.
and an approximation of the time-average vorticity fluxes
\begin{equation}
	\Phi_{i+\frac{1}{2},j+\frac{1}{2}}^n \approx
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} \Phi
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt.
\end{equation}
\subsection{C-grid discretization of momentum equation }
to update the normalized covariant D-grid winds:
\begin{align}
	\label{2d-sweq-cscheme-u}
	{U}_{i+\frac{1}{2},j}^{n+1}&=
	{U}_{i+\frac{1}{2},j}^{n} -\Delta t \bigg[
	\frac{\delta_i K_{i+\frac{1}{2},j}^n}{\hat{\delta} x_{i+\frac{1}{2},j}}
	+\frac{\delta_i \Phi_{i+\frac{1}{2},j}^n}{\hat{\delta} x_{i+\frac{1}{2},j}} -
	\frac{1}{\Delta t}
	\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}
	\frac{\mathfrak{v}\sqrt{\mathfrak{g}}\xi(x_{i+\frac{1}{2}}, y_j, t)}{\Delta x}
	\,dx \bigg)
	\,dt \bigg],\\
	\label{2d-sweq-cscheme-v}
	{V}_{i,j+\frac{1}{2}}^{n+1}&=
	{V}_{i,j+\frac{1}{2}}^{n} -\Delta t \bigg[
	\frac{\delta_j K_{i,j+\frac{1}{2}}}{\hat{\delta} y_{i,j+\frac{1}{2}}}+
	\frac{\delta_j \Phi_{{i,j+\frac{1}{2}}}^n}{\hat{\delta} y_{i,j+\frac{1}{2}}}
	+
	\frac{1}{\Delta t}
	\int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}} 
	\frac{\mathfrak{u}\sqrt{\mathfrak{g}}\xi(x_{i+\frac{1}{2}}, y, t)}{\Delta y}
	\,dy \bigg)\,dt\bigg],
\end{align}
Then, this schemes requires an approximation of the time-averaged kinetic energy at the B-grid
\begin{equation}
	K_{i+\frac{1}{2},j+\frac{1}{2}}^n \approx \frac{1}{2}\bigg[
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} {u}{U}
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt +
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} {v}{V}
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt)\bigg],
\end{equation}
an approximation of the time-averaged geopotential on B-grid points:
\begin{equation}
	\Phi_{i+\frac{1}{2},j+\frac{1}{2}}^n \approx
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} \Phi
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt,
\end{equation}
and an approximation of the time-average vorticity fluxes
\begin{equation}
	\Phi_{i+\frac{1}{2},j+\frac{1}{2}}^n \approx
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} \Phi
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt.
\end{equation}
These approximations are described in Section \ref{dsw-grid}.
\subsection{C-grid intermediate step}
\label{csw-grid}
C-grid equation

\subsubsection{Wind interpolation}
We are given  the normalized covariant wind components  on a D-grid
that is, we have $U_{i,j+\frac{1}{2}}^n$ for $i=0,\ldots,N$, $j=1,\ldots,N$, 
and $V_{i+\frac{1}{2},j}^n$ $j=0,\ldots,N$, $i=1,\ldots,N$.
We may then use the duo-grid interpolation (Section \ref{cs-wind-interp}) to get the values on the duo-grid.
After that, we have all the values 
$U_{i,j+\frac{1}{2}}^n$ for $i=0,\ldots,N+\nu$, $j=1,\ldots,N+\nu$, 
and $V_{i+\frac{1}{2},j}^n$ $j=0,\ldots,N+\nu$, $i=1,\ldots,N+\nu$.


We define the average operator in the $x$ direction as:
\begin{align}
	\label{av-x}
	\overline{q_{ij}}^x =
	\begin{cases}
	0.5(q_{i+\frac{1}{2},j}+q_{i-\frac{1}{2},j}), 
	\quad &
	\text{if } i=-\nu+1 \text{ or } i=N+\nu,\\
	\frac{9}{16}(q_{i+\frac{1}{2},j}+q_{i-\frac{1}{2},j}) - \frac{1}{16}(q_{i+\frac{3}{2},j}+q_{i-\frac{3}{2},j}), 
	\quad &
	\text{otherwise},\\
\end{cases}
\end{align}
for any integer $i$ and integer or half integer $j$, and
\begin{align}
	\label{av-xx}
	\overline{q_{i+\frac{1}{2},j}}^x =
	\begin{cases}
		0.5(q_{i+1,j}+q_{ij}), 
		\quad &
		\text{if } i=-\nu+1 \text{ or } i=N+\nu,\\
		\frac{9}{16}(q_{i+1,j}+q_{ij}) - \frac{1}{16}(q_{i+2,j}+q_{i-1,j}), 
		\quad &
		\text{otherwise},\\
	\end{cases}
\end{align}
for any integer $i$ and integer or half integer $j$.
The average operator $\overline{q_{ij}}^y$ in the $y$ direction is defined analogously.


We may interpolate the normalized covariant component $U$ from the D-grid to A-grid by using the average in the $y$ direction:
\begin{align}
	\label{d2a-u}
	 U_{ij}^n &= \overline{U_{ij}^n}^y,%\frac{U_{i,j+\frac{1}{2}}^n + U_{i,j-\frac{1}{2}}^n}{2},
\end{align}
for $i=-\nu+1,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $V$ component:
\begin{align}
	\label{d2a-v}
	V_{ij}^n &=\overline{V_{ij}^n}^x,
\end{align}
for $j=-\nu+1,\ldots,N+\nu$, $i=-\nu+1,\ldots,N+\nu$.

Moreover, using the A-grid covariant wind, we may convert the wind from 
covariant to contravariant on the A-grid representation using Equation \eqref{norm-contravariant-to-covariant}:
\begin{align}
	\label{a-c2c-u}
	u_{ij}^n &= \frac{1}{\sin^2{\alpha}_{ij}}\bigg(U_{ij}^n - \cos{\alpha}_{ij}V_{ij}^n\bigg),
\end{align}
for $i=-\nu+1,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $v$ component:
\begin{align}
	\label{a-c2c-v}
	v_{ij}^n &= \frac{1}{\sin^2{\alpha}_{ij}}\bigg(V_{ij}^n - \cos{\alpha}_{ij}U_{ij}^n\bigg),
\end{align}
for $j=-\nu+1,\ldots,N+\nu$, $i=-\nu+1,\ldots,N+\nu$.

Using the A-grid covariant wind, we may interpolate it to the C-grid covariant wind as:
\begin{align}
	\label{d2a-uu}
	U_{i+\frac{1}{2},j}^n &= \overline{U_{i+\frac{1}{2},j}^n}^x,
\end{align}
for $i=-\nu+2,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $V$ component:
\begin{align}
	\label{d2a-vv}
	V_{i,j+\frac{1}{2}}^n &= \overline{V_{i,j+\frac{1}{2}}^n}^y,
\end{align}
for $i=-\nu+1,\ldots,N+\nu$, $j=-\nu+2,\ldots,N+\nu$.

Then, we may get the covariant C-grid wind using the original contravariant D-grid wind:
\begin{align}
	\label{d2a-uuu}
	u_{i+\frac{1}{2},j}^n &= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j}}}
	\bigg({U_{i+\frac{1}{2},j}^n} - \cos{\alpha_{i+\frac{1}{2},j}} {V_{i+\frac{1}{2},j}^n}\bigg),
\end{align}
for $i=-\nu+2,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $v$ component:
\begin{align}
	\label{d2a-vvv}
	v_{i,j+\frac{1}{2}}^n &= \frac{1}{\sin^2{\alpha_{i,j+\frac{1}{2}}}}
	\bigg({V_{i,j+\frac{1}{2}}^n} - \cos{\alpha_{i,j+\frac{1}{2}}}{U_{i,j+\frac{1}{2}}^n}\bigg),
\end{align}
for $i=-\nu+1,\ldots,N+\nu$, $j=-\nu+2,\ldots,N+\nu$.

And similarly, we obtain the D-grid contravariant wind:
\begin{align}
	\label{d2a-uuuu}
	v_{i+\frac{1}{2},j}^n &= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j}}}
	\bigg({V_{i+\frac{1}{2},j}^n} - \cos{\alpha_{i+\frac{1}{2},j}} {U_{i+\frac{1}{2},j}^n}\bigg),
\end{align}
for $i=-\nu+2,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $u$ component:
\begin{align}
	\label{d2a-vvvv}
	u_{i,j+\frac{1}{2}}^n &= \frac{1}{\sin^2{\alpha_{i,j+\frac{1}{2}}}}
	\bigg({U_{i,j+\frac{1}{2}}^n} - \cos{\alpha_{i,j+\frac{1}{2}}}{V_{i,j+\frac{1}{2}}^n}\bigg),
\end{align}
\subsubsection{Fluid depth}
The fluid depth is update using the upwind scheme, expressed as:
\begin{equation}
	\label{2d-continuity-eq-Cgrid}
	h^{n+\frac{1}{2}}_{ij} =
	h^{n}_{ij} + \mathbf{F}_{ij}^{UPW}[{h^n,{u}^{n}}]  + \mathbf{G}_{ij}^{UPW}[{h^n,{v}^{n}}],
\end{equation}
for $i,j=0,\ldots,N+1$,
where the upwind update operators are given by
\begin{align}
	\mathbf{F}_{ij}^{UPW}[{h^n,u^{n}}] = 
	-\frac{1}{|\hat{\Omega}_{ij}|}
	\bigg(\mathcal{A}_{i+\frac{1}{2},j}^{x} \mathcal{F}_{i+\frac{1}{2},j}^{UPW,x}[h^n,{u}^{n}]-
	      \mathcal{A}_{i-\frac{1}{2},j}^{x} \mathcal{F}_{i-\frac{1}{2},j}^{UPW,x}[h^n,{u}^{n}] \bigg),
\end{align}
and
\begin{align}
	\mathbf{G}_{ij}^{UPW}[{h^n,v^{n}}] = 
	-\frac{1}{|\hat{\Omega}_{ij}|}
	\bigg(\mathcal{A}_{i,j+\frac{1}{2}}^{y} \mathcal{F}_{i,j+\frac{1}{2}}^{UPW,y}[h^n,{v}^{n}]-
          \mathcal{A}_{i,j-\frac{1}{2}}^{y} \mathcal{F}_{i,j-\frac{1}{2}}^{UPW,y}[h^n,{v}^{n}] \bigg),
\end{align}
where
\begin{align}
	%	\label{chp3-flux-xdir}
	\mathcal{A}_{i+\frac{1}{2},j}^{x} = \frac{\Delta t}{2} \times
	\begin{cases}
		\Delta y
		\sqrt{\mathfrak{g}}_{i+\frac{1}{2},j}
		\mathfrak{u}_{i+\frac{1}{2},j}^n=
		\hat{\delta} y_{i+\frac{1}{2},j}
		\sin{\alpha_{i+\frac{1}{2},j}}
		{u}_{i+\frac{1}{2},j}^n
		\quad &
		\text{for mt0},\\
		\Delta y
		\mathfrak{u}_{i+\frac{1}{2},j}^n
		\quad &
		\text{for mt1},\\
	\end{cases}
\end{align}
and
\begin{align}
	\mathcal{F}_{i+\frac{1}{2},j}^{UPW,x} [{h}^n,u^n]= 
	\begin{cases}
		\mathfrak{F}_{i+\frac{1}{2},j}^{UPW,x}[{{\sqrt{\mathfrak{g}}h}^n},u^n],
		\quad &\text{for mt0},\\
		\mathfrak{F}_{i+\frac{1}{2},j}^{UPW,x}[{h}^n,u^n],
		\quad &\text{for mt1},
	\end{cases}
\end{align}
where the 1D upwind flux in the $x$ direction is defined by:
\begin{align}
	%	\label{chp3-flux-xdir}
	\mathfrak{F}_{i+\frac{1}{2},j}^{UPW,x} [{{\psi}^n},u^n]=
	\begin{cases}
		{\psi}_{ij}^n
		\quad &\text{if} \quad 
		{u}_{i+\frac{1}{2},j}^{n}>0,\\
		{\psi}_{i+1,j}^n
		\quad &\text{if} \quad 
		\mathfrak{u}_{i+\frac{1}{2},j}^{n}\leq0,\\
	\end{cases}
\end{align}
for $i=0, \ldots, N$, $j=-\nu+1, \ldots, N + \nu$.
The terms, $\mathcal{A}_{i,j+\frac{1}{2}}^{y}$ and	$\mathcal{F}_{i,j+\frac{1}{2}}^{UPW,y}$ are defined similarly using $v$.

\subsubsection{Geopotential gradient}
Once we have computed $h^{n+\frac{1}{2}}_{ij}$, we are able to estimate the geopotential on the A-grid as:
\begin{align}
	\label{2d-sw-eq-Cgrid-geo}
	 \Phi^n_{ij} &= {g(h^{n+\frac{1}{2}}_{ij} + b_{ij})},
\end{align}
for $i,j=0, \ldots, N+1$.
We use $h^{n+\frac{1}{2}}_{ij}$ instead of $h^{n}_{ij}$ so the C-grid scheme becomes backward-forward in time;
otherwise, the C-grid scheme would be unconditionally unstable \citep{lin:1997}.
Following that, we estimate the geopotential gradient on the C-grid and D-grid points, respectively, by using centered differences:
\begin{align}
	\label{2d-sw-eq-Cgrid-geo-dx}
	\delta_i \Phi^n_{i+\frac{1}{2},j} &= {g(h^{n+\frac{1}{2}}_{i+1,j} - h^{n+\frac{1}{2}}_{ij} + b_{i+1,j} - b_{ij})},
	\quad i=0,\ldots,N, j=1,\ldots,N,\\
	\label{2d-sw-eq-Cgrid-geo-dy}
	\delta_j \Phi^n_{i,j+\frac{1}{2}} &= {g(h^{n+\frac{1}{2}}_{i,j+1} - h^{n+\frac{1}{2}}_{ij} + b_{i,j+1} - b_{ij})},
	\quad i=1,\ldots,N, j=0,\ldots,N.
\end{align}
\subsubsection{Absolute vorticity fluxes}
Using the C-grid covariant winds $(U_{i+\frac{1}{2},j}^n,V_{i,j+\frac{1}{2}}^n)$,
we may compute the relative vorticity (Equation \eqref{vort2-eq}) at the B-grid points using a centered finite difference:
\begin{align}
	\label{2d-sw-rv-Cgrid}
	\zeta_{i+\frac{1}{2},j+\frac{1}{2}}^n &= \frac{1}{\sqrt{\mathfrak{g}}_{i+\frac{1}{2},j+\frac{1}{2}}}\bigg[
	\frac{\mathfrak{V}_{i+1,j+\frac{1}{2}}^n-\mathfrak{V}_{i,j+\frac{1}{2}}^n}{\Delta x} -
	\frac{\mathfrak{U}_{i+\frac{1}{2},j+1}^n-\mathfrak{U}_{i+\frac{1}{2},j}^n}{\Delta y}
\bigg]\nonumber\\
	&= 
    \frac{1}{|\hat{\Omega}_{i+\frac{1}{2},j+\frac{1}{2}}|}\bigg[
         {\big({\hat{\delta}y_{i+1,j+\frac{1}{2}}{V}_{i+1,j+\frac{1}{2}}^n-
    	   \hat{\delta}y_{i  ,j+\frac{1}{2}}{V}_{i  ,j+\frac{1}{2}}^n}\big)} -
         {\big({\hat{\delta}x_{i+\frac{1}{2},j+1}{U}_{i+\frac{1}{2},j+1}^n-
    	   \hat{\delta}x_{i+\frac{1}{2},j  }{U}_{i+\frac{1}{2},j}^n}\big)}
    \bigg],
\end{align}
for $i,j=0, \ldots, N$.
Then, we obtain the absolute vorticity on the B-grid as:
\begin{align}
	\label{2d-sw-av-Cgrid}
	\xi_{i+\frac{1}{2},j+\frac{1}{2}}^n =
	f_{i+\frac{1}{2},j+\frac{1}{2}} +
	\zeta_{i+\frac{1}{2},j+\frac{1}{2}}^n,
\end{align}
for $i,j=0, \ldots, N$.
Thus, it follows from Equation \eqref{absvort-eq} that absolute vorticity may be updated on the B-grid as follows using the upwind flux:
\begin{equation}
	\label{2d-avort-eq-Cgrid}
	\xi^{n+1}_{i+\frac{1}{2},j+\frac{1}{2}}  =
	\xi^{n}_{i+\frac{1}{2},j+\frac{1}{2}} + 
	\mathbf{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{UPW}[{\xi^n,{u}^{n}}]  + 
	\mathbf{G}_{i+\frac{1}{2},j+\frac{1}{2}}^{UPW}[{\xi^n,{v}^{n}}],
\end{equation}
for $i,j=0, \ldots, N$.
The upwind update operators on the B-grid are given by
\begin{align}
	\mathbf{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{UPW}[{\xi^n,u^{n}}] = 
	\frac{-1}{|\hat{\Omega}_{i+\frac{1}{2},j+\frac{1}{2}}|}
	\bigg(\mathcal{A}_{i+1,j+\frac{1}{2}}^{x} \mathcal{F}_{i+1,j+\frac{1}{2}}^{UPW,x}[\xi^n,{u}^{n}]-
          \mathcal{A}_{i  ,j+\frac{1}{2}}^{x} \mathcal{F}_{i  ,j+\frac{1}{2}}^{UPW,x}[\xi^n,{u}^{n}] \bigg),
\end{align}
and
\begin{align}
	\mathbf{G}_{i+\frac{1}{2},j+\frac{1}{2}}^{UPW}[{\zeta^n,v^{n}}] = 
	\frac{-1}{|\hat{\Omega}_{i+\frac{1}{2},j+\frac{1}{2}}|}
	\bigg(\mathcal{A}_{i+\frac{1}{2},j+1}^{y} \mathcal{F}_{i+\frac{1}{2},j+1}^{UPW,y}[\xi^n,{v}^{n}]-
          \mathcal{A}_{i+\frac{1}{2},j  }^{y} \mathcal{F}_{i+\frac{1}{2},j  }^{UPW,y}[\xi^n,{v}^{n}] \bigg),
\end{align}
where
\begin{align}
	%	\label{chp3-flux-xdir}
	\mathcal{A}_{i,j+\frac{1}{2}}^{x} = \frac{\Delta t}{2} \times
	\begin{cases}
		\Delta y
		\sqrt{\mathfrak{g}}_{i,j+\frac{1}{2}}
		\mathfrak{u}_{i,j+\frac{1}{2}}^n=
		\hat{\delta} y_{i,j+\frac{1}{2}}
		\sin{\alpha_{i,j+\frac{1}{2}}}
		{u}_{i,j+\frac{1}{2}}^n
		\quad &
		\text{for mt0},\\
		\Delta y
		\mathfrak{u}_{i,j+\frac{1}{2}}^n
		\quad &
		\text{for mt1},\\
	\end{cases}
\end{align}
and
\begin{align}
	\mathcal{F}_{i,j+\frac{1}{2}}^{UPW,x} [{\xi}^n,u^n]= 
	\begin{cases}
		\mathfrak{F}_{i,j+\frac{1}{2}}^{UPW,x}[{{\sqrt{\mathfrak{g}}\xi}^n},u^n],
		\quad &\text{for mt0},\\
		\mathfrak{F}_{i,j+\frac{1}{2}}^{UPW,x}[{\xi}^n,u^n],
		\quad &\text{for mt1},
	\end{cases}
\end{align}
where the 1D upwind flux in the $x$ direction is defined by:
\begin{align}
	%	\label{chp3-flux-xdir}
	\mathfrak{F}_{i,j+\frac{1}{2}}^{UPW,x} [{{\psi}^n},u^n]=
	\begin{cases}
		{\psi}_{i-\frac{1}{2},j+\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{u}_{i,j+\frac{1}{2}}^{n}>0,\\
		{\psi}_{i+\frac{1}{2},j+\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{u}_{i,j+\frac{1}{2}}^{n}\leq0,\\
	\end{cases}
\end{align}
The terms $\mathcal{A}_{i+\frac{1}{2},j}^{y}$ and	$\mathcal{F}_{i+\frac{1}{2},j}^{UPW,y}$ are defined similarly using $v$.
Notice that the D-grid contravariant winds $(u_{i,j+\frac{1}{2}}^n,v_{i+\frac{1}{2},j}^n)$ are needed for the upwind flux on the B-grid.

Finally we point out that we do not need to update the absolute vorticity using Equation \eqref{2d-avort-eq-Cgrid}, instead, 
we only need to compute the terms and  $\mathcal{A}_{i,j+\frac{1}{2}}^{x}$ and $\mathcal{F}_{i,j+\frac{1}{2}}^{UPW,x}$
for $i=0, \ldots, N$, $j=1,\ldots,N$, and $\mathcal{A}_{i+\frac{1}{2},j}^{y}$ and $\mathcal{F}_{i+\frac{1}{2},j}^{UPW,y}$
for $i=1, \ldots, N$, $j=0,\ldots,N$, to update the C-grid winds using
the momentum equations \eqref{2d-sweq-cscheme-u} and \eqref{2d-sweq-cscheme-v}.

\subsubsection{Kinetic energy fluxes}
The time-averaged kinetic on the A-grid is computed using the formula:
\begin{equation}
	K_{ij}^n = \frac{1}{2}\bigg(
	{u}_{ij}^{n}\mathfrak{F}_{ij}^{UPW,x} [{{U}^n},u^n] +
    {v}_{ij}^{n}\mathfrak{F}_{ij}^{UPW,y} [{{V}^n},v^n]\bigg),
\end{equation}
for $i,j=0,\ldots,N+1$,
where we have the 1D upwind flux in the $x$ direction
\begin{align}
	\mathfrak{F}_{ij}^{UPW,x} [{{U}^n},u^n]=
	\begin{cases}
		{U}_{i-\frac{1}{2},j}^n
		\quad &\text{if} \quad 
		{u}_{ij}^{n}>0,\\
		{U}_{i+\frac{1}{2},j}^n
		\quad &\text{if} \quad 
		{u}_{ij}^{n}\leq0,\\
	\end{cases}
\end{align}
and the 1D upwind flux in the $y$ direction
\begin{align}
	\mathfrak{F}_{ij}^{UPW,y} [{{V}^n},v^n]=
	\begin{cases}
		{V}_{i,j-\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{v}_{ij}^{n}>0,\\
		{V}_{i,j+\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{v}_{ij}^{n}\leq0.\\
	\end{cases}
\end{align}
In this step, we use the A-grid contravariant winds ${u}_{ij}^{n},{v}_{ij}^{n}$ obtained in Equations \eqref{a-c2c-u} and \eqref{a-c2c-v}.
We also use the C-grid covariant winds obtained in Equations \eqref{d2a-uu} and \eqref{d2a-vv}.
Thus, we estimate the kinetic energy gradient using a centered difference:
\begin{align}
	\label{2d-sw-eq-Cgrid-ke-dx}
	\delta_i K^n_{i+\frac{1}{2},j} &= K_{i+1,j}^n - K_{ij}^n,
	\quad i=0,\ldots,N, j=1,\ldots,N,\\
	\label{2d-sw-eq-Cgrid-ke-dy}
	\delta_j K^n_{i,j+\frac{1}{2}} &= K_{i,j+1}^n - K_{ij}^n,
	\quad i=1,\ldots,N, j=0,\ldots,N.
\end{align}

\subsection{D-grid step}
\label{dsw-grid}
D-grid equation
\begin{align}
	\label{2d-sw-eq-Dgrid}
	{\partial_t (\sqrt{\mathfrak{g}} {h})}_{ij}(t) & = 
	-[{\partial_x (\mathfrak{u}\sqrt{\mathfrak{g}}{h}})
	+ {\partial_y (\mathfrak{v}\sqrt{\mathfrak{g}}{h}})]_{ij}(t), \\
	{\partial_t \mathfrak{U}}_{i,j+\frac{1}{2}}(t)&=
	-[\partial_x K -  \mathfrak{v}\sqrt{\mathfrak{g}}\xi +\partial_x \Phi ]_{i,j+\frac{1}{2}} (t), \\
	{\partial_t \mathfrak{V}}_{i+\frac{1}{2},j}(t)&=
	-[\partial_y K + \mathfrak{u}\sqrt{\mathfrak{g}}\xi +\partial_y \Phi ]_{i+\frac{1}{2},j}(t), 
\end{align}

\subsubsection{Wind interpolation}
We are given  the normalized covariant wind components on a C-grid
that is, we have $V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}$ for $i=0,\ldots,N$, $j=1,\ldots,N$, 
and $U_{i+\frac{1}{2},j}^{n+\frac{1}{2}}$ $j=0,\ldots,N$, $i=1,\ldots,N$, obtained in the C-grid intermediate step.
We may then use the duo-grid interpolation (Section \ref{cs-wind-interp}) to get the values on the duo-grid.
After that, we have all the values 
$V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}$ for $i=0,\ldots,N+\nu$, $j=1,\ldots,N+\nu$, 
and $U_{i+\frac{1}{2},j}^{n+\frac{1}{2}}$ $j=0,\ldots,N+\nu$, $i=1,\ldots,N+\nu$.

We may interpolate the covariant wind $V$ from D-grid points to C-grid points as
\begin{equation}
\label{cova-2-contra-V}
V_{i+\frac{1}{2},j}^{n+\frac{1}{2}}	= \frac{1}{4}\big(
V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}} + V_{i+1,j+\frac{1}{2}}^{n+\frac{1}{2}} + 
V_{i,j-\frac{1}{2}}^{n+\frac{1}{2}} + V_{i+1,j-\frac{1}{2}}^{n+\frac{1}{2}}
\big),
\end{equation}
for $i=-1,\ldots,N+2, j=-\nu+1,\ldots,N+\nu$,	
and similarly to the covariant wind $U$ from C-grid points to D-grid points as
\begin{equation}
	\label{cova-2-contra-U}
	U_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}	= \frac{1}{4}\big(
	U_{i+\frac{1}{2},j}^{n+\frac{1}{2}} + U_{i+\frac{1}{2},j+1}^{n+\frac{1}{2}} + 
	U_{i-\frac{1}{2},j}^{n+\frac{1}{2}} + U_{i-\frac{1}{2},j+1}^{n+\frac{1}{2}}
	\big),
\end{equation}
for $j=-1,\ldots,N+2, i=-\nu+1,\ldots,N+\nu$.

Thus, we obtain and similarly to the contravariant wind $u$ at C-grid points applying Equation \eqref{norm-contravariant-to-covariant}:
\begin{equation}
	\label{cova-2-contra-UU}
	u_{i+\frac{1}{2},j}^{n+\frac{1}{2}}	= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j}}}\bigg(
	U_{i+\frac{1}{2},j}^{n+\frac{1}{2}} - \cos{\alpha_{i+\frac{1}{2},j}}V_{i+\frac{1}{2},j}^{n+\frac{1}{2}}\bigg),
\end{equation}
for $i=-1,\ldots,N+2, j=-\nu+1,\ldots,N+\nu$, and similarly to the contravariant wind $v$ at D-grid points:
\begin{equation}
	\label{cova-2-contra-VV}
	v_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}	= \frac{1}{\sin^2{\alpha_{i,j+\frac{1}{2}}}}\bigg(
	V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}} - \cos{\alpha_{i,j+\frac{1}{2}}}U_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}\bigg).
\end{equation}
for $j=-1,\ldots,N+2, i=-\nu+1,\ldots,N+\nu$.
Hence, we have the C-grid contravariant time-averaged winds that are needed for the flux operators.

For the kinetic energy fluxes, we require B-grid winds. 
For this reason, we compute the covariant B-grid wind using:
\begin{equation}
	\label{bgrid-U}
	U_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}	= 
	\frac{1}{2}\big(U_{i+\frac{1}{2},j+1}^{n+\frac{1}{2}} + U_{i+\frac{1}{2},j}^{n+\frac{1}{2}} \big),
\end{equation}
for $i=-1,\ldots,N+2, j=-\nu+1,\ldots,N+\nu$, and
\begin{equation}
	\label{bgrid-V}
	V_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}	= 
	\frac{1}{2}\big(V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}} + V_{i+1,j+\frac{1}{2}}^{n+\frac{1}{2}} \big),
\end{equation}
and then we convert the winds from covariant to contravariant as
\begin{equation}
	\label{bgrid-UU}
	u_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}	= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j+\frac{1}{2}}}}\bigg(
	U_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}} - \cos{\alpha_{i+\frac{1}{2},j+\frac{1}{2}}}V_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}\bigg),
\end{equation}
for $i=-1,\ldots,N+2, j=-\nu+1,\ldots,N+\nu$, and similarly to the contravariant wind $v$ at D-grid points:
\begin{equation}
	\label{bgrid-VV}
	v_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}	= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j+\frac{1}{2}}}}\bigg(
	V_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}} - \cos{\alpha_{i+\frac{1}{2},j+\frac{1}{2}}}U_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}\bigg).
\end{equation}

\subsubsection{Kinetic energy fluxes}
We also need to estimate the time-averaged kinetic energy on the B-grid, denoted as:
\begin{equation}
	K_{i+\frac{1}{2},j+\frac{1}{2}} = \frac{1}{2}\bigg[
	\frac{1}{\Delta x}
	\int_{t_{n}}^{t_{n+1}} {u}{U}
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt +
	\frac{1}{\Delta t}
	\int_{t_{n}}^{t_{n+1}} {v}{V}
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt)\bigg]
\end{equation}
In \citet{lin:1996} and in the current FV3 implementation, it is assumed that the $u$ and $U$ obeys:
\begin{equation}
	\label{eq_duu}
	{\partial_t U} + {\partial_x (uU)}(x, y_{j+\frac{1}{2}}, t) = 0,
\end{equation}
then, using an 1D finite-volume numerical flux $F_{i+\frac{1}{2},j+\frac{1}{2}}$ (recall Problem \ref{chp-adv1d-sec2-prob4}), we may approximate 
\begin{equation}
	F_{i+\frac{1}{2},j+\frac{1}{2}}[U^n,u^n]\approx 
	\frac{1}{\Delta t}	\int_{t_{n}}^{t_{n+1}} {u}{U}
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt
\end{equation}
Similarly for $v$ and $V$, we use	$F_{i+\frac{1}{2},j+\frac{1}{2}}[V^n,v^n]$ an then we have an estimation for the time-averaged kinetic energy. Equation \eqref{eq_duu} is not true.
The time-averaged kinetic on the A-grid is computed using the formula:
\begin{equation}
	K_{i+\frac{1}{2},j+\frac{1}{2}}^n = \frac{1}{2}\bigg(
	{u}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}\mathfrak{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{PPM,x} [{{U}^n},u^{n+\frac{1}{2}}] +
	{v}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}\mathfrak{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{PPM,y} [{{V}^n},v^{n+\frac{1}{2}}]\bigg),
\end{equation}
for $i,j=0,\ldots,N$,
where we have the 1D upwind flux in the $x$ direction
\begin{align}
	\mathfrak{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{PPM,x} [{{U}^n},u^{n+\frac{1}{2}}]=
	\begin{cases}
		{U}_{i,j+\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{u}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}>0,\\
		{U}_{i+1,j+\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{u}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}\leq0,\\
	\end{cases}
\end{align}
and the 1D upwind flux in the $y$ direction
\begin{align}
	\mathfrak{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{PPM,y} [{{V}^n},v^{n+\frac{1}{2}}]=
	\begin{cases}
		{V}_{i+\frac{1}{2},j}^n
		\quad &\text{if} \quad 
		{v}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}>0,\\
		{V}_{i+\frac{1}{2},j+1}^n
		\quad &\text{if} \quad 
		{v}_{i+\frac{1}{2},j+1}^{n+\frac{1}{2}}\leq0.\\
	\end{cases}
\end{align}
In this step, we use the B-grid contravariant winds 
${u}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}},{v}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}$
obtained in Equations \eqref{a-c2c-u} and \eqref{a-c2c-v}.
We also use the C-grid covariant winds obtained in Equations \eqref{d2a-uu} and \eqref{d2a-vv}.
Thus, we estimate the kinetic energy gradient using a centered difference:
\begin{align}
	\label{2d-sw-eq-Dgrid-ke-dx}
	\delta_i K^n_{i+\frac{1}{2},j} &= K_{i+1,j}^n - K_{ij}^n,
	\quad i=0,\ldots,N, j=1,\ldots,N,\\
	\label{2d-sw-eq-Dgrid-ke-dy}
	\delta_j K^n_{i,j+\frac{1}{2}} &= K_{i,j+1}^n - K_{ij}^n,
	\quad i=1,\ldots,N, j=0,\ldots,N.
\end{align}
