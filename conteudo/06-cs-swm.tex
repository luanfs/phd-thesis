\chapter{Cubed-sphere finite-volume shallow-water model}
\label{chp-cs-swm}

Now that we have described how to solve the advection equation on the cubed-sphere in Chapter \ref{chp-cs-fv},
we are able to introduce the method of \citet{lin:1997} for solving the shallow-water equations (SWE) on the cubed-sphere.
In fact, this scheme considers the SWE in the vector invariant form, and therefore, 
the flux operators discussed in Chapter \ref{chp-cs-fv} are used to update the fluid depth,
as well as the time-averaged relative vorticity and kinetic energy fluxes.
This scheme first solves the SWE for a half time-step to obtain covariant C-grid winds and 
then utilizes this new information to advance the covariant D-grid winds for a full time step.
The C-grid half-step employs upwind flux operators, which are computationally inexpensive, 
while the D-grid uses PPM-based fluxes, providing higher accuracy. 
We note that other flux operators could be employed here, but the choice presented is what is utilized in FV3.

Although the advection equation on the sphere plays a crucial role in the development of dynamical cores by modeling the advection of scalar fields on the sphere, 
it does not capture important features present in the SWE on the sphere, 
such as the Coriolis effect, inertia-gravity waves, geostrophic adjustment, Rossby waves, among others. 
Therefore, SWE serve as an excellent benchmark for assessing dynamical cores in general,
as they are only two-dimensional but represent a complex geophysical model for atmosphere dynamics.
Furthermore, the 3D non-hydrostatic solver of FV3 utilizes a vertical Lagrangian coordinate system,
requiring the solution of the shallow-water equations on the Lagrangian surfaces \citep{lin:2004, harris:2021}.

The goal of this Chapter is to provide a detailed description of the SWE solver from \citet{lin:1997}.
Since this scheme uses advection operators to update the variables, 
we are going to incorporate the new advection scheme LT introduced in Chapter \ref{chp-cs-fv} and compare it with the PL advection scheme from \citet{putman:2007},
which is currently employed in FV3. 
Thus, we will extend the comparisons made in Chapter \ref{chp-cs-fv} to the context of the SWE.

This Chapter is outlined as follows:
In Section \ref{sec:sweq}, we introduce the SWE and some of its properties, and then we discuss
the C-grid and D-grid discretization proposed by \citet{lin:1997} in Section \ref{sw:fv3solver}.
Our modifications for their scheme are presented in Section \ref{sw-modf}.
Following that, in Section \ref{sec:numerical_results}, 
we present numerical results using classical tests from the literature. 
Finally, in Section \ref{sec:conclusions}, we provide concluding remarks.

\section{The shallow-water equations on the sphere}
\label{sec:sweq}
In this Section, we introduce the shallow-water equations (SWE) on the sphere using a cubed-sphere mapping 
(equi-edge or equiangular) as discussed in Section \ref{sec-cs-grids}.
All the notation from Sections \ref{cs-mappings} and \ref{sec-cs-grids} is utilized here.
For simplicity, we omit the dependence on $p$ since it does not affect the description across cube faces.
Additionally, we assume that the ghost cells are filled using the duo-grid interpolation scheme outlined in Sections \ref{cs-interp} and \ref{cs-wind-interp}.
The shallow-water equations (SWE) are a set of hyperbolic partial differential equations describing how the fluid depth, 
denoted by $h$, and the wind $\boldsymbol{u}$ evolve with time.
Since the cubed-sphere system is non-orthogonal, the SWEs will feature the covariant winds $\mathfrak{U}, \mathfrak{V}$ and
contravariant winds $\mathfrak{u}, \mathfrak{v}$, as discussed in Section \ref{cs-tgvectors}.
The SWE on the a cubed-sphere panel are expressed as in its vector invariant form as \citep{rancic:1996, nair:2005b}:
\begin{align}
	\label{2d-sweq-h}
	{\partial_t (\sqrt{\mathfrak{g}} {h})}(x, y, t) &= -
	[{\partial_x (\mathfrak{u}\sqrt{\mathfrak{g}}{h}}
	+ {\partial_y (\mathfrak{v}\sqrt{\mathfrak{g}}{h})}](x, y, t), \\
	\label{2d-sweq-u}
	{\partial_t \mathfrak{U}}(x, y, t)&=
	-[\partial_x K - \mathfrak{v}\sqrt{\mathfrak{g}}\xi +\partial_x \Phi] (x, y, t), \\
	\label{2d-sweq-v}
	{\partial_t \mathfrak{V}}(x, y, t)&=
	-[\partial_y K + \mathfrak{u}\sqrt{\mathfrak{g}}\xi + \partial_y \Phi](x, y, t), 
\end{align}
$\Phi = g(h+b)$ is the geopotential, $g$ is the gravity, $b$ is the bottom topography,
\begin{equation}
	\label{ke-eq}
	K = \frac{\mathfrak{u}\mathfrak{U}+\mathfrak{v}\mathfrak{V}}{2},
\end{equation}
is the kinetic energy,
\begin{equation}
	\label{vort-eq}
	\xi = f+ \zeta,
\end{equation}
is the absolute vorticity, where
\begin{equation}
	\label{coriolis-eq}
	f  = 2 \Omega \sin{\phi},
\end{equation}
is the Coriolis parameter,
$\phi$ is the latitude, $\Omega = 7.2921 \times 10^{-5}$ is the Earth rotation speed, and
\begin{equation}
	\label{vort2-eq}
	\zeta = \frac{1}{\sqrt{\mathfrak{g}}}(\partial_x \mathfrak{V} - \partial_y\mathfrak{U}),
\end{equation}
is the relative vorticity.

%\section{Elementary properties of the SWE}
%\label{sec:sweq-prop}
Now, let us describe some elementary properties of the SWE.
By taking $\partial_y$ in Equation \eqref{2d-sweq-u} and $\partial_x$ in Equation \eqref{2d-sweq-v} and
subtracting the obtained results, we get that the absolute vorticity satisfies:
\begin{align}
	\label{absvort-eq}
	{\partial_t (\sqrt{\mathfrak{g}} {\zeta})}(x,y,t) & = 
	-[{\partial_x (\mathfrak{u}\sqrt{\mathfrak{g}}{\zeta}})
	+ {\partial_y (\mathfrak{v}\sqrt{\mathfrak{g}}{\zeta}})](x,y,t).
\end{align}
One can also easily show (as described in Section \ref{chp-cs-adv}) that the total mass of $h$ and $\zeta$ is preserved.

By replacing Equations \eqref{contra-uv} and \eqref{covari-uv} in Equation \eqref{ke-eq}, 
it follows that the kinetic energy may be rewritten in terms of the normalized contravariant and covariant components as:
\begin{equation}
	\label{ke-eq2}
	K = \frac{{u}{U}+{v}{V}}{2}.
\end{equation}

The total energy is defined as:
\begin{equation}
	\label{energy}
	E = g\frac{h^2}{2} + gb + hK.
\end{equation}
One can deduce an equation for the time evolution of the total energy (see, for example, \citet{ringler:2010}) 
and observe that its integral over the sphere is preserved; that is, the total energy is conserved.
%The total entrosphy is defined as
%\begin{equation}
%	\label{enstrophy}
%	E = g\frac{h^2}{2} + gb + hK,
%\end{equation}

\subsection{Momentum equation discretization}
The continuity equation \eqref{2d-sweq-h} has the exact same form as the advection equation when written in its conservative form.
Therefore, this equation can be solved on the A-grid using C-grid winds, as explored in Chapters \ref{chp-2d-fv} and \ref{chp-cs-fv}.
This is how the continuity equation is solved in FV3.
As we shall see later, this equation is solved twice: 
once using the 2D upwind flux and another using the dimension-splitting method from Chapter \ref{chp-cs-fv} with PPM.

Therefore, we need to describe how we can solve the momentum equations \eqref{2d-sweq-u} and \eqref{2d-sweq-v}. 
The method of \citet{lin:1997} employs two types of approaches on their shallow-water solver: one using a C-grid wind and the other using a D-grid.
The C-grid method serves as an intermediate step utilized by the D-grid method.
Our goal now is to describe a general discretization of the momentum equations for the C-grid and D-grid winds.
The full description of the C-grid and D-grid solvers proposed by 
\citet{lin:1997} will be provided in Sections \ref{csw-grid} and \ref{dsw-grid}, respectively.

\subsubsection{D-grid discretization of momentum equation }
We introduce the following average operators for the covariant components in $x$ and $y$ directions, respectively:
\begin{align}
	\label{2d-sweq-int_u}
	\overline{\mathfrak{U}^x_{i,j+\frac{1}{2}}}(t)&= \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \mathfrak{U}(x, y_{j+\frac{1}{2}}, t) \,dx , \quad i=1,\ldots,N,j=0,\ldots, N,\\
	\label{2d-sweq-int_v}
	\overline{\mathfrak{V}^y_{i+\frac{1}{2},j}}(t)&= \frac{1}{\Delta y} \int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}} \mathfrak{V}(x_{i+\frac{1}{2}}, y, t) \,dy,  \quad i=0,\ldots,N,j=1,\ldots, N.
\end{align}
We shall also use the notation $q_{ij}(t) = q(x_i,y_j,t)$ for any function $q$ and integer or half-integer indices $i$ and $j$.
We also use the centered difference notations $\delta _i q_{ij}(t) =q_{i+\frac{1}{2},j}(t) -q_{i-\frac{1}{2},j}(t)$ and 
$\delta _j q_{ij}(t) = q_{i,j+\frac{1}{2}}(t) -q_{i,j-\frac{1}{2}}(t)$ for any integer or half-integer indices $i$ and $j$.

By integrating Equation \eqref{2d-sweq-u} with respect to $x$ on $[x_{i-\frac{1}{2}},x_{i+\frac{1}{2}}]$ and Equation \eqref{2d-sweq-v} with respect to $y$ on $[y_{j-\frac{1}{2}},y_{j+\frac{1}{2}}]$, we get the following equations:
\begin{align}
	\label{2d-sweq-int_equ}
	\frac{d}{dt}\overline{\mathfrak{U}^x_{i,j+\frac{1}{2}}}
	(t)&= -\frac{\delta_i K_{i,j+\frac{1}{2}}(t)}{\Delta x}-\frac{\delta_i \Phi_{i,j+\frac{1}{2}}(t)}{\Delta x} + 
	\frac{1}{\Delta x}
	\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}
	(\mathfrak{v}\sqrt{\mathfrak{g}}\xi)(x_i, y_{j+\frac{1}{2}}, t) \,dx, \\
	\label{2d-sweq-int_eqv}
	\frac{d}{dt} \overline{\mathfrak{V}^y_{i+\frac{1}{2},j}}(t)&= -\frac{\delta_j K_{i+\frac{1}{2},j}(t)}{\Delta y}-
	\frac{\delta_j \Phi_{i+\frac{1}{2},j}(t)}{\Delta y}
	- \frac{1}{\Delta y}
	\int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}} 
	(\mathfrak{u}\sqrt{\mathfrak{g}}\xi)(x_{i+\frac{1}{2}}, y, t) \,dy.
\end{align}
Integrating Equations \eqref{2d-sweq-int_equ} and \eqref{2d-sweq-int_eqv} on time over $[t^n,t^{n+1}]$, we obtain:
\begin{align}
	\label{2d-sweq-int_equt}
	\overline{\mathfrak{U}^x_{i,j+\frac{1}{2}}}(t^{n+1})&=
	\overline{\mathfrak{U}^x_{i,j+\frac{1}{2}}}(t^{n}) -
	\int_{t_{n}}^{t_{n+1}}\bigg[
	\frac{\delta_i K_{i,j+\frac{1}{2}}(t)}{\Delta x}
	+\frac{\delta_i \Phi_{i,j+\frac{1}{2}}(t)}{\Delta x} - \bigg(
	\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}
	\frac{(\mathfrak{v}\sqrt{\mathfrak{g}}\xi)(x_i, y_{j+\frac{1}{2}}, t)}{\Delta x}
	\,dx \bigg)\bigg]
	\,dt ,\\
	\label{2d-sweq-int_eqvt}
	\overline{\mathfrak{V}^y_{i+\frac{1}{2},j}}(t^{n+1})&=
	\overline{\mathfrak{V}^y_{i+\frac{1}{2},j}}(t^{n}) -
	\int_{t_{n}}^{t_{n+1}}\bigg[
	\frac{\delta_j K_{i+\frac{1}{2},j}(t)}{\Delta y}+\frac{\delta_j\Phi_{i+\frac{1}{2},j}(t)}{\Delta y}+ \bigg(
	\int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}} 
	\frac{(\mathfrak{u}\sqrt{\mathfrak{g}}\xi)(x_{i+\frac{1}{2}}, y, t)}{\Delta y}
	\,dy \bigg)\bigg]\,dt .
\end{align}
Using the midpoint rule and using the normalized covariant winds in Equations \eqref{2d-sweq-int_equt} and \eqref{2d-sweq-int_eqvt}, we derive a general scheme
to update the normalized covariant D-grid winds:
\begin{align}
	\label{2d-sweq-dscheme-u}
	{U}_{i,j+\frac{1}{2}}^{n+1}&=
	{U}_{i,j+\frac{1}{2}}^{n} - \bigg(
	\frac{\delta_i K_{i,j+\frac{1}{2}}^n}{\hat{\delta} x_{i,j+\frac{1}{2}}}
	+\frac{\delta_i \Phi_{i,j+\frac{1}{2}}^n}{\hat{\delta} x_{i,j+\frac{1}{2}}}
	- \frac{G_{i,j+\frac{1}{2}}}{{\hat{\delta} x_{i,j+\frac{1}{2}}}}[\xi, v^n]\bigg)
	,\\
	\label{2d-sweq-dscheme-v}
	{V}_{i+\frac{1}{2},j}^{n+1}&=
	{V}_{i+\frac{1}{2},j}^{n} - \bigg(
	\frac{\delta_j K_{i+\frac{1}{2},j}}{\hat{\delta} y_{i+\frac{1}{2},j}}+
	\frac{\delta_j \Phi_{{i+\frac{1}{2}},j}^n}{\hat{\delta} y_{i+\frac{1}{2},j}}
	+ \frac{F_{i+\frac{1}{2},j}[\xi, u^n]}{\hat{\delta} y_{i+\frac{1}{2},j}} \bigg).
\end{align}
Then, this schemes requires an approximation of the time-averaged kinetic energy at the B-grid:
\begin{equation}
	\label{ke-bgrid}
	K_{i+\frac{1}{2},j+\frac{1}{2}}^n \approx \frac{1}{2}\bigg[
	\int_{t_{n}}^{t_{n+1}} ({u}{U})(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt +
	\int_{t_{n}}^{t_{n+1}} ({v}{V})(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt\bigg],
\end{equation}
and an approximation of the time-averaged geopotential on B-grid points:
\begin{equation}
	\label{geop-bgrid}
	\Phi_{i+\frac{1}{2},j+\frac{1}{2}}^n \approx
	\int_{t_{n}}^{t_{n+1}} \Phi
	(x_{i+\frac{1}{2}}, y_{j+\frac{1}{2}}, t) \,dt,
\end{equation}
The terms should $F_{i+\frac{1}{2},j}[\xi^{n}, u^n]$ and $G_{i,j+\frac{1}{2}}[\xi^{n}, v^n] $ should approximate the time-averaged absolute vorticity fluxes:
\begin{align}
	F_{i+\frac{1}{2},j}[\xi^{n}, u^n] \approx
	\int_{t^n}^{t^{n+1}} 
	\int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}} 
	{(\mathfrak{u}\sqrt{\mathfrak{g}}\xi)(x_{i+\frac{1}{2}}, y, t)}
	\,dy \,dt \\
	G_{i,j+\frac{1}{2}}[\xi^{n}, v^n] \approx
	\int_{t^n}^{t^{n+1}} 
    \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} 
    {(\mathfrak{v}\sqrt{\mathfrak{g}}\xi)(x, y_{j+\frac{1}{2}}, t)}
    \,dx \,dt.
\end{align}
Notice that since $\xi$ satisfies the advection equation \eqref{absvort-eq}, 
these integrals may be approximated using finite-volume fluxes assuming that $\xi$ may be advected on the A-grid.
Indeed, this is possible because, as we shall see soon, the D-grid facilitates the estimation of $\xi$ on the A-grid by using centered finite differences.
All these approximations needed for the D-grid scheme are described in Section \ref{dsw-grid}.


\subsubsection{C-grid discretization of momentum equation }
Similar to the derivation of the D-grid wind scheme, we may deduce the following C-grid scheme for a half-time step:
\begin{align}
	\label{2d-sweq-cscheme-u}
	{U}_{i+\frac{1}{2},j}^{n+1}&=
	{U}_{i+\frac{1}{2},j}^{n} - \bigg(
	\frac{\delta_i K_{i+\frac{1}{2},j}^n}{\hat{\delta} x_{i+\frac{1}{2},j}}
	+\frac{\delta_i \Phi_{i+\frac{1}{2},j}^n}{\hat{\delta} x_{i+\frac{1}{2},j}} -
    \frac{G_{i+\frac{1}{2},j}[\xi^{n}, v^n]}{\hat{\delta} x_{i+\frac{1}{2},j}}\bigg),\\
	\label{2d-sweq-cscheme-v}
	{V}_{i,j+\frac{1}{2}}^{n+1}&=
	{V}_{i,j+\frac{1}{2}}^{n} - \bigg(
	\frac{\delta_j K_{i,j+\frac{1}{2}}}{\hat{\delta} y_{i,j+\frac{1}{2}}}+
	\frac{\delta_j \Phi_{{i,j+\frac{1}{2}}}^n}{\hat{\delta} y_{i,j+\frac{1}{2}}}
	+
   \frac{F_{i,j+\frac{1}{2}}[\xi, u^n]}{\hat{\delta} y_{i,j+\frac{1}{2}}}\bigg).
\end{align}
Then, this schemes requires an approximation of the time-averaged kinetic energy at the A-grid
\begin{equation}
	\label{ke-agrid}
	K_{ij}^n \approx \frac{1}{2}\bigg[
	\int_{t_{n}}^{t_{n+\frac{1}{2}}} ({u}{U})
	(x_{i}, y_{j}, t) \,dt +
	\int_{t_{n}}^{t_{n+\frac{1}{2}}} ({v}{V})
	(x_{i}, y_{j}, t) \,dt\bigg],
\end{equation}
and an approximation of the time-averaged geopotential on A-grid points:
\begin{equation}
	\label{geop-agrid}
	\Phi_{ij}^n \approx
	\int_{t_{n}}^{t_{n+\frac{1}{2}}} \Phi
	(x_{i}, y_{j}, t) \,dt.
\end{equation}
The terms should $F_{i,j+\frac{1}{2}}[\xi^{n}, u^n]$ and $G_{i+\frac{1}{2},j}[\xi^{n}, v^n] $ should approximate the time-averaged absolute vorticity fluxes:
\begin{align}
	F_{i,j+\frac{1}{2}}[\xi^{n}, u^n] \approx
	\int_{t^n}^{t^{n+\frac{1}{2}}} 
	\int_{y_{j}}^{y_{j+1}} 
	{(\mathfrak{u}\sqrt{\mathfrak{g}}\xi)(x_{i}, y, t)}
	\,dy \,dt \\
	G_{i+\frac{1}{2},j}[\xi^{n}, v^n] \approx
	\int_{t^n}^{t^{n+\frac{1}{2}}} 
	\int_{x_{i}}^{x_{i+1}} 
	{(\mathfrak{v}\sqrt{\mathfrak{g}}\xi)(x, y_{j}, t)}
	\,dx \,dt.
\end{align}
Once again, since $\xi$ satisfies the advection equation \eqref{absvort-eq}, 
these integrals may be approximated using finite-volume fluxes assuming that $\xi$ may be advected on the B-grid.
Indeed, this is possible because, as we shall see soon, the C-grid facilitates the estimation of $\xi$ on the B-grid by using centered finite differences.
All these approximations are described in Section \ref{csw-grid}.

\section{The FV3 shallow-water solver}
\label{sw:fv3solver}
This Section is dedicated to presenting all the details of the shallow-water solver proposed by \citet{lin:1997} on the cubed-sphere. 
The C-grid intermediate step is described in Section \ref{csw-grid}, while the D-grid step is detailed in Section \ref{dsw-grid}.

\subsection{C-grid intermediate step}
\label{csw-grid}
The C-grid intermediate step serves to provide the contravariant C-grid winds centered at time 
${u}^{n+\frac{1}{2}}_{i+\frac{1}{2},j}$ and ${v}^{n+\frac{1}{2}}_{i,j+\frac{1}{2}}$
that are required by the advection fluxes when using PPM, as discussed in Chapters \ref{chp-2d-fv} and \ref{chp-cs-fv}. 
One could utilize second-order extrapolation to obtain these centered at time C-grid winds, using two time levels, namely:
\begin{align}
{u}^{n+\frac{1}{2}}_{i+\frac{1}{2},j} = \frac{3}{2} {u}^{n}_{i,j+\frac{1}{2}} - \frac{1}{2} {u}^{n-1}_{i,j+\frac{1}{2}}, \\
{v}^{n+\frac{1}{2}}_{i,j+\frac{1}{2}} = \frac{3}{2} {v}^{n}_{i,j+\frac{1}{2}} - \frac{1}{2} {v}^{n-1}_{i,j+\frac{1}{2}}.
\end{align}
This approach is very popular in Semi-Lagrangian methods.
However, as pointed out by \citet{lin:1997}, this extrapolation introduces 2$\Delta x$ numerical noise, which may degrade the solution in presence
of sharp bottom topography. 
Therefore, \citet{lin:1997} proposes solving the SWE on a C-grid for a half-time step to provide the winds centered at time $n+\frac{1}{2}$. 
To make this half-time step cheaper, upwind fluxes are going to be used.
Our goal now is to describe the details of this C-grid wind solver.
We are going to describe everything that is needed to advance the 
C-grid winds given by Equations \eqref{2d-sweq-cscheme-u} and \eqref{2d-sweq-cscheme-v}.

\subsubsection{Wind interpolation}
We are given  the normalized covariant wind components  on a D-grid
that is, we have $U_{i,j+\frac{1}{2}}^n$ for $i=0,\ldots,N$, $j=1,\ldots,N$, 
and $V_{i+\frac{1}{2},j}^n$ $j=0,\ldots,N$, $i=1,\ldots,N$.
We may then use the duo-grid interpolation (Section \ref{cs-wind-interp}) to get the values on the duo-grid.
After that, we have all the values 
$U_{i,j+\frac{1}{2}}^n$ for $i=0,\ldots,N+\nu$, $j=1,\ldots,N+\nu$, 
and $V_{i+\frac{1}{2},j}^n$ $j=0,\ldots,N+\nu$, $i=1,\ldots,N+\nu$.


We define the average operator in the $x$ direction as:
\begin{align}
	\label{av-x}
	\overline{q_{ij}}^x =
	\begin{cases}
	0.5(q_{i+\frac{1}{2},j}+q_{i-\frac{1}{2},j}), 
	\quad &
	\text{if } i=-\nu+1 \text{ or } i=N+\nu,\\
	\frac{9}{16}(q_{i+\frac{1}{2},j}+q_{i-\frac{1}{2},j}) - \frac{1}{16}(q_{i+\frac{3}{2},j}+q_{i-\frac{3}{2},j}), 
	\quad &
	\text{otherwise},\\
\end{cases}
\end{align}
for any integer $i$ and integer or half integer $j$, and
\begin{align}
	\label{av-xx}
	\overline{q_{i+\frac{1}{2},j}}^x =
	\begin{cases}
		0.5(q_{i+1,j}+q_{ij}), 
		\quad &
		\text{if } i=-\nu+1 \text{ or } i=N+\nu,\\
		\frac{9}{16}(q_{i+1,j}+q_{ij}) - \frac{1}{16}(q_{i+2,j}+q_{i-1,j}), 
		\quad &
		\text{otherwise},\\
	\end{cases}
\end{align}
for any integer $i$ and integer or half integer $j$.
The average operator $\overline{q_{ij}}^y$ in the $y$ direction is defined analogously.


We may interpolate the normalized covariant component $U$ from the D-grid to A-grid by using the average in the $y$ direction:
\begin{align}
	\label{d2a-u}
	 U_{ij}^n &= \overline{U_{ij}^n}^y,%\frac{U_{i,j+\frac{1}{2}}^n + U_{i,j-\frac{1}{2}}^n}{2},
\end{align}
for $i=-\nu+1,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $V$ component:
\begin{align}
	\label{d2a-v}
	V_{ij}^n &=\overline{V_{ij}^n}^x,
\end{align}
for $j=-\nu+1,\ldots,N+\nu$, $i=-\nu+1,\ldots,N+\nu$.

Moreover, using the A-grid covariant wind, we may convert the wind from 
covariant to contravariant on the A-grid representation using Equation \eqref{norm-contravariant-to-covariant}:
\begin{align}
	\label{a-c2c-u}
	u_{ij}^n &= \frac{1}{\sin^2{\alpha}_{ij}}\bigg(U_{ij}^n - \cos{\alpha}_{ij}V_{ij}^n\bigg),
\end{align}
for $i=-\nu+1,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $v$ component:
\begin{align}
	\label{a-c2c-v}
	v_{ij}^n &= \frac{1}{\sin^2{\alpha}_{ij}}\bigg(V_{ij}^n - \cos{\alpha}_{ij}U_{ij}^n\bigg),
\end{align}
for $j=-\nu+1,\ldots,N+\nu$, $i=-\nu+1,\ldots,N+\nu$.

Using the A-grid covariant wind, we may interpolate it to the C-grid covariant wind as:
\begin{align}
	\label{d2a-uu}
	U_{i+\frac{1}{2},j}^n &= \overline{U_{i+\frac{1}{2},j}^n}^x,
\end{align}
for $i=-\nu+2,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $V$ component:
\begin{align}
	\label{d2a-vv}
	V_{i,j+\frac{1}{2}}^n &= \overline{V_{i,j+\frac{1}{2}}^n}^y,
\end{align}
for $i=-\nu+1,\ldots,N+\nu$, $j=-\nu+2,\ldots,N+\nu$.

Then, we may get the covariant C-grid wind using the original contravariant D-grid wind:
\begin{align}
	\label{d2a-uuu}
	u_{i+\frac{1}{2},j}^n &= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j}}}
	\bigg({U_{i+\frac{1}{2},j}^n} - \cos{\alpha_{i+\frac{1}{2},j}} {V_{i+\frac{1}{2},j}^n}\bigg),
\end{align}
for $i=-\nu+2,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $v$ component:
\begin{align}
	\label{d2a-vvv}
	v_{i,j+\frac{1}{2}}^n &= \frac{1}{\sin^2{\alpha_{i,j+\frac{1}{2}}}}
	\bigg({V_{i,j+\frac{1}{2}}^n} - \cos{\alpha_{i,j+\frac{1}{2}}}{U_{i,j+\frac{1}{2}}^n}\bigg),
\end{align}
for $i=-\nu+1,\ldots,N+\nu$, $j=-\nu+2,\ldots,N+\nu$.

And similarly, we obtain the D-grid contravariant wind:
\begin{align}
	\label{d2a-uuuu}
	v_{i+\frac{1}{2},j}^n &= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j}}}
	\bigg({V_{i+\frac{1}{2},j}^n} - \cos{\alpha_{i+\frac{1}{2},j}} {U_{i+\frac{1}{2},j}^n}\bigg),
\end{align}
for $i=-\nu+2,\ldots,N+\nu$, $j=-\nu+1,\ldots,N+\nu$, and similarly to the $u$ component:
\begin{align}
	\label{d2a-vvvv}
	u_{i,j+\frac{1}{2}}^n &= \frac{1}{\sin^2{\alpha_{i,j+\frac{1}{2}}}}
	\bigg({U_{i,j+\frac{1}{2}}^n} - \cos{\alpha_{i,j+\frac{1}{2}}}{V_{i,j+\frac{1}{2}}^n}\bigg),
\end{align}
\subsubsection{Fluid depth}
The fluid depth is update using the upwind scheme, expressed as:
\begin{equation}
	\label{2d-continuity-eq-Cgrid}
	h^{n+\frac{1}{2}}_{ij} =
	h^{n}_{ij} + \mathbf{F}_{ij}^{UPW}[{h^n,{u}^{n}}]  + \mathbf{G}_{ij}^{UPW}[{h^n,{v}^{n}}],
\end{equation}
for $i,j=0,\ldots,N+1$,
where the upwind update operators are given by
\begin{align}
	\mathbf{F}_{ij}^{UPW}[{h^n,u^{n}}] = 
	-\frac{1}{|\hat{\Omega}_{ij}|}
	\bigg(\mathcal{A}_{i+\frac{1}{2},j}^{x} \mathcal{F}_{i+\frac{1}{2},j}^{UPW,x}[h^n,{u}^{n}]-
	      \mathcal{A}_{i-\frac{1}{2},j}^{x} \mathcal{F}_{i-\frac{1}{2},j}^{UPW,x}[h^n,{u}^{n}] \bigg),
\end{align}
and
\begin{align}
	\mathbf{G}_{ij}^{UPW}[{h^n,v^{n}}] = 
	-\frac{1}{|\hat{\Omega}_{ij}|}
	\bigg(\mathcal{A}_{i,j+\frac{1}{2}}^{y} \mathcal{F}_{i,j+\frac{1}{2}}^{UPW,y}[h^n,{v}^{n}]-
          \mathcal{A}_{i,j-\frac{1}{2}}^{y} \mathcal{F}_{i,j-\frac{1}{2}}^{UPW,y}[h^n,{v}^{n}] \bigg),
\end{align}
where
\begin{align}
	%	\label{chp3-flux-xdir}
	\mathcal{A}_{i+\frac{1}{2},j}^{x} = \frac{\Delta t}{2} \times
	\begin{cases}
		\Delta y
		\sqrt{\mathfrak{g}}_{i+\frac{1}{2},j}
		\mathfrak{u}_{i+\frac{1}{2},j}^n=
		\hat{\delta} y_{i+\frac{1}{2},j}
		\sin{\alpha_{i+\frac{1}{2},j}}
		{u}_{i+\frac{1}{2},j}^n
		\quad &
		\text{for mt0},\\
		\Delta y
		\mathfrak{u}_{i+\frac{1}{2},j}^n
		\quad &
		\text{for mt1},\\
	\end{cases}
\end{align}
and
\begin{align}
	\mathcal{F}_{i+\frac{1}{2},j}^{UPW,x} [{h}^n,u^n]= 
	\begin{cases}
		\mathfrak{F}_{i+\frac{1}{2},j}^{UPW,x}[{{\sqrt{\mathfrak{g}}h}^n},u^n],
		\quad &\text{for mt0},\\
		\mathfrak{F}_{i+\frac{1}{2},j}^{UPW,x}[{h}^n,u^n],
		\quad &\text{for mt1},
	\end{cases}
\end{align}
where the 1D upwind flux in the $x$ direction is defined by:
\begin{align}
	%	\label{chp3-flux-xdir}
	\mathfrak{F}_{i+\frac{1}{2},j}^{UPW,x} [{{\psi}^n},u^n]=
	\begin{cases}
		{\psi}_{ij}^n
		\quad &\text{if} \quad 
		{u}_{i+\frac{1}{2},j}^{n}>0,\\
		{\psi}_{i+1,j}^n
		\quad &\text{if} \quad 
		\mathfrak{u}_{i+\frac{1}{2},j}^{n}\leq0,\\
	\end{cases}
\end{align}
for $i=0, \ldots, N$, $j=-\nu+1, \ldots, N + \nu$.
The terms, $\mathcal{A}_{i,j+\frac{1}{2}}^{y}$ and	$\mathcal{F}_{i,j+\frac{1}{2}}^{UPW,y}$ are defined similarly using $v$.

We recall the metric term discussion of PPM presented in Section \ref{sec-metricppm} is also valid for the upwind flux,
and therefore the same methods of metric term formulation, mt0 and mt1, presented there are valid in this context.

\subsubsection{Geopotential gradient}
Once we have computed $h^{n+\frac{1}{2}}_{ij}$, we are able to estimate the time-averaged geopotential (Equation \eqref{geop-agrid}) on the A-grid as:
\begin{align}
	\label{2d-sw-eq-Cgrid-geo}
	 \Phi^n_{ij} &= \Delta t {g(h^{n+\frac{1}{2}}_{ij} + b_{ij})},
\end{align}
for $i,j=0, \ldots, N+1$.
We use $h^{n+\frac{1}{2}}_{ij}$ instead of $h^{n}_{ij}$ so the C-grid scheme becomes backward-forward in time;
otherwise, the C-grid scheme would be unconditionally unstable \citep{lin:1997}.
Following that, we estimate the geopotential gradient on the C-grid and D-grid points, respectively, by using centered differences:
\begin{align}
	\label{2d-sw-eq-Cgrid-geo-dx}
	\delta_i \Phi^n_{i+\frac{1}{2},j} &= \Phi^{n}_{i+1,j} - \Phi^{n}_{ij},
	\quad i=0,\ldots,N, j=1,\ldots,N,\\
	\label{2d-sw-eq-Cgrid-geo-dy}
	\delta_j \Phi^n_{i,j+\frac{1}{2}} &= \Phi^{n}_{i,j+1} - \Phi^{n}_{ij},
	\quad i=1,\ldots,N, j=0,\ldots,N.
\end{align}
\subsubsection{Absolute vorticity fluxes}
Using the C-grid covariant winds $(U_{i+\frac{1}{2},j}^n,V_{i,j+\frac{1}{2}}^n)$,
we may compute the relative vorticity (Equation \eqref{vort2-eq}) at the B-grid points using a centered finite difference:
\begin{align}
	\label{2d-sw-rv-Cgrid}
	\zeta_{i+\frac{1}{2},j+\frac{1}{2}}^n &= \frac{1}{\sqrt{\mathfrak{g}}_{i+\frac{1}{2},j+\frac{1}{2}}}\bigg[
	\frac{\mathfrak{V}_{i+1,j+\frac{1}{2}}^n-\mathfrak{V}_{i,j+\frac{1}{2}}^n}{\Delta x} -
	\frac{\mathfrak{U}_{i+\frac{1}{2},j+1}^n-\mathfrak{U}_{i+\frac{1}{2},j}^n}{\Delta y}
\bigg]\nonumber\\
	&= 
    \frac{1}{|\hat{\Omega}_{i+\frac{1}{2},j+\frac{1}{2}}|}\bigg[
         {\big({\hat{\delta}y_{i+1,j+\frac{1}{2}}{V}_{i+1,j+\frac{1}{2}}^n-
    	   \hat{\delta}y_{i  ,j+\frac{1}{2}}{V}_{i  ,j+\frac{1}{2}}^n}\big)} -
         {\big({\hat{\delta}x_{i+\frac{1}{2},j+1}{U}_{i+\frac{1}{2},j+1}^n-
    	   \hat{\delta}x_{i+\frac{1}{2},j  }{U}_{i+\frac{1}{2},j}^n}\big)}
    \bigg],
\end{align}
for $i,j=-1, \ldots, N+1$.
Then, we obtain the absolute vorticity on the B-grid as:
\begin{align}
	\label{2d-sw-av-Cgrid}
	\xi_{i+\frac{1}{2},j+\frac{1}{2}}^n =
	f_{i+\frac{1}{2},j+\frac{1}{2}} +
	\zeta_{i+\frac{1}{2},j+\frac{1}{2}}^n,
\end{align}
for $i,j=-1, \ldots, N+1$.
Thus, it follows from Equation \eqref{absvort-eq} that absolute vorticity may be updated on the B-grid as follows using the upwind flux:
\begin{equation}
	\label{2d-avort-eq-Cgrid}
	\xi^{n+1}_{i+\frac{1}{2},j+\frac{1}{2}}  =
	\xi^{n}_{i+\frac{1}{2},j+\frac{1}{2}} + 
	\mathbf{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{UPW}[{\xi^n,{u}^{n}}]  + 
	\mathbf{G}_{i+\frac{1}{2},j+\frac{1}{2}}^{UPW}[{\xi^n,{v}^{n}}],
\end{equation}
for $i,j=0, \ldots, N$.
The upwind update operators on the B-grid are given by
\begin{align}
	\mathbf{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{UPW}[{\xi^n,u^{n}}] = 
	\frac{-1}{|\hat{\Omega}_{i+\frac{1}{2},j+\frac{1}{2}}|}
	\bigg(\mathcal{A}_{i+1,j+\frac{1}{2}}^{x} \mathcal{F}_{i+1,j+\frac{1}{2}}^{UPW,x}[\xi^n,{u}^{n}]-
          \mathcal{A}_{i  ,j+\frac{1}{2}}^{x} \mathcal{F}_{i  ,j+\frac{1}{2}}^{UPW,x}[\xi^n,{u}^{n}] \bigg),
\end{align}
and
\begin{align}
	\mathbf{G}_{i+\frac{1}{2},j+\frac{1}{2}}^{UPW}[{\zeta^n,v^{n}}] = 
	\frac{-1}{|\hat{\Omega}_{i+\frac{1}{2},j+\frac{1}{2}}|}
	\bigg(\mathcal{A}_{i+\frac{1}{2},j+1}^{y} \mathcal{F}_{i+\frac{1}{2},j+1}^{UPW,y}[\xi^n,{v}^{n}]-
          \mathcal{A}_{i+\frac{1}{2},j  }^{y} \mathcal{F}_{i+\frac{1}{2},j  }^{UPW,y}[\xi^n,{v}^{n}] \bigg),
\end{align}
where
\begin{align}
	%	\label{chp3-flux-xdir}
	\mathcal{A}_{i,j+\frac{1}{2}}^{x} = \frac{\Delta t}{2} \times
	\begin{cases}
		\Delta y
		\sqrt{\mathfrak{g}}_{i,j+\frac{1}{2}}
		\mathfrak{u}_{i,j+\frac{1}{2}}^n=
		\hat{\delta} y_{i,j+\frac{1}{2}}
		\sin{\alpha_{i,j+\frac{1}{2}}}
		{u}_{i,j+\frac{1}{2}}^n
		\quad &
		\text{for mt0},\\
		\Delta y
		\mathfrak{u}_{i,j+\frac{1}{2}}^n
		\quad &
		\text{for mt1},\\
	\end{cases}
\end{align}
and
\begin{align}
	\mathcal{F}_{i,j+\frac{1}{2}}^{UPW,x} [{\xi}^n,u^n]= 
	\begin{cases}
		\mathfrak{F}_{i,j+\frac{1}{2}}^{UPW,x}[{{\sqrt{\mathfrak{g}}\xi}^n},u^n],
		\quad &\text{for mt0},\\
		\mathfrak{F}_{i,j+\frac{1}{2}}^{UPW,x}[{\xi}^n,u^n],
		\quad &\text{for mt1},
	\end{cases}
\end{align}
where the 1D upwind flux in the $x$ direction is defined by:
\begin{align}
	%	\label{chp3-flux-xdir}
	\mathfrak{F}_{i,j+\frac{1}{2}}^{UPW,x} [{{\psi}^n},u^n]=
	\begin{cases}
		{\psi}_{i-\frac{1}{2},j+\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{u}_{i,j+\frac{1}{2}}^{n}>0,\\
		{\psi}_{i+\frac{1}{2},j+\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{u}_{i,j+\frac{1}{2}}^{n}\leq0.\\
	\end{cases}
\end{align}
The terms $\mathcal{A}_{i+\frac{1}{2},j}^{y}$ and	$\mathcal{F}_{i+\frac{1}{2},j}^{UPW,y}$ are defined similarly using $v$.
Notice that the D-grid contravariant winds $(u_{i,j+\frac{1}{2}}^n,v_{i+\frac{1}{2},j}^n)$ are needed for the upwind flux on the B-grid.

Finally we point out that we do not need to update the absolute vorticity using Equation \eqref{2d-avort-eq-Cgrid}, instead, 
we only need to compute the terms and  $\mathcal{A}_{i,j+\frac{1}{2}}^{x}$ and $\mathcal{F}_{i,j+\frac{1}{2}}^{UPW,x}$
for $i=0, \ldots, N$, $j=1,\ldots,N$, and $\mathcal{A}_{i+\frac{1}{2},j}^{y}$ and $\mathcal{F}_{i+\frac{1}{2},j}^{UPW,y}$
for $i=1, \ldots, N$, $j=0,\ldots,N$, to update the C-grid winds using
the momentum equations \eqref{2d-sweq-cscheme-u} and \eqref{2d-sweq-cscheme-v}.
That is, we only need to compute the terms:
\begin{align}
F_{i,j+\frac{1}{2}}[\xi^{n}, u^n] = \mathcal{A}_{i,j+\frac{1}{2}}^{x}\mathcal{F}_{i,j+\frac{1}{2}}^{UPW,x}[\xi^{n}, u^n],\\
G_{i+\frac{1}{2},j}[\xi^{n}, v^n] = \mathcal{A}_{i+\frac{1}{2},j}^{y}\mathcal{F}_{i+\frac{1}{2},j}^{UPW,y}[\xi^{n}, v^n].
\end{align}


\subsubsection{Kinetic energy fluxes}
To estimate the kinetic energy fluxes, we need to estimate the temporal integrals in Equation \eqref{ke-agrid}.
In \citet{lin:1997} and in the current FV3 implementation, it is assumed that the $u$ and $U$ obeys:
\begin{equation}
	\label{eq_du}
	{\partial_t U} + {\partial_x (uU)}(x, y_j, t) = 0,
\end{equation}
then, using an 1D finite-volume numerical flux $F_{i+\frac{1}{2},j}^x$ (recall Problem \ref{chp-adv1d-sec2-prob4}), we may approximate 
\begin{equation}
	F_{i+\frac{1}{2},j}^x[U^n,u^n]\approx 
	\frac{1}{0.5\Delta t} \int_{t_{n}}^{t_{n+\frac{1}{2}}} {u}{U}
	(x_{i+\frac{1}{2}}, y_{j}, t) \,dt
\end{equation}
Similarly for $v$ and $V$, we use	$F_{i,j+\frac{1}{2}}^y[V^n,v^n]$ an then we have an estimation for the time-averaged kinetic energy.
Of course, Equation \eqref{eq_du} is not true, but it is used to advected the wind on a upwind direction.

Therefore, the time-averaged kinetic on the A-grid is computed using the formula:
\begin{equation}
	K_{ij}^n = \frac{0.5\Delta t}{2}\bigg(
	{u}_{ij}^{n}\mathfrak{F}_{ij}^{UPW,x} [{{U}^n},u^n] +
    {v}_{ij}^{n}\mathfrak{F}_{ij}^{UPW,y} [{{V}^n},v^n]\bigg),
\end{equation}
for $i,j=0,\ldots,N+1$,
where we have the 1D upwind flux in the $x$ direction
\begin{align}
	\mathfrak{F}_{ij}^{UPW,x} [{{U}^n},u^n]=
	\begin{cases}
		{U}_{i-\frac{1}{2},j}^n
		\quad &\text{if} \quad 
		{u}_{ij}^{n}>0,\\
		{U}_{i+\frac{1}{2},j}^n
		\quad &\text{if} \quad 
		{u}_{ij}^{n}\leq0,\\
	\end{cases}
\end{align}
and the 1D upwind flux in the $y$ direction
\begin{align}
	\mathfrak{F}_{ij}^{UPW,y} [{{V}^n},v^n]=
	\begin{cases}
		{V}_{i,j-\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{v}_{ij}^{n}>0,\\
		{V}_{i,j+\frac{1}{2}}^n
		\quad &\text{if} \quad 
		{v}_{ij}^{n}\leq0.\\
	\end{cases}
\end{align}
In this step, we use the A-grid contravariant winds ${u}_{ij}^{n},{v}_{ij}^{n}$ obtained in Equations \eqref{a-c2c-u} and \eqref{a-c2c-v}.
We also use the C-grid covariant winds obtained in Equations \eqref{d2a-uu} and \eqref{d2a-vv}.
Thus, we estimate the kinetic energy gradient using a centered difference:
\begin{align}
	\label{2d-sw-eq-Cgrid-ke-dx}
	\delta_i K^n_{i+\frac{1}{2},j} &= K_{i+1,j}^n - K_{ij}^n,
	\quad i=0,\ldots,N, j=1,\ldots,N,\\
	\label{2d-sw-eq-Cgrid-ke-dy}
	\delta_j K^n_{i,j+\frac{1}{2}} &= K_{i,j+1}^n - K_{ij}^n,
	\quad i=1,\ldots,N, j=0,\ldots,N.
\end{align}
Hence, we have completed the description of the C-grid wind update on a half-step using Equations \eqref{2d-sweq-cscheme-u} and \eqref{2d-sweq-cscheme-v}.


\subsection{D-grid step}
\label{dsw-grid}
Now we are going to describe how we can advance the D-grid scheme,
given by Equations \eqref{2d-sweq-dscheme-u} and \eqref{2d-sweq-dscheme-v},
using the C-grid winds $U_{i+\frac{1}{2},j}^{n+\frac{1}{2}}$ and $V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}$ centered at time obtained by the C-grid solver.

\subsubsection{Wind interpolation}
We are given  the normalized covariant wind components on a C-grid
that is, we have $V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}$ for $i=0,\ldots,N$, $j=1,\ldots,N$, 
and $U_{i+\frac{1}{2},j}^{n+\frac{1}{2}}$ $j=0,\ldots,N$, $i=1,\ldots,N$, obtained in the C-grid intermediate step.
We may then use the duo-grid interpolation (Section \ref{cs-wind-interp}) to get the values on the duo-grid.
After that, we have all the values 
$V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}$ for $i=0,\ldots,N+\nu$, $j=1,\ldots,N+\nu$, 
and $U_{i+\frac{1}{2},j}^{n+\frac{1}{2}}$ $j=0,\ldots,N+\nu$, $i=1,\ldots,N+\nu$.

We may interpolate the covariant wind $V$ from D-grid points to C-grid points as
\begin{equation}
\label{cova-2-contra-V}
V_{i+\frac{1}{2},j}^{n+\frac{1}{2}}	= \frac{1}{4}\big(
V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}} + V_{i+1,j+\frac{1}{2}}^{n+\frac{1}{2}} + 
V_{i,j-\frac{1}{2}}^{n+\frac{1}{2}} + V_{i+1,j-\frac{1}{2}}^{n+\frac{1}{2}}
\big),
\end{equation}
for $i=-1,\ldots,N+2, j=-\nu+1,\ldots,N+\nu$,	
and similarly to the covariant wind $U$ from C-grid points to D-grid points as
\begin{equation}
	\label{cova-2-contra-U}
	U_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}	= \frac{1}{4}\big(
	U_{i+\frac{1}{2},j}^{n+\frac{1}{2}} + U_{i+\frac{1}{2},j+1}^{n+\frac{1}{2}} + 
	U_{i-\frac{1}{2},j}^{n+\frac{1}{2}} + U_{i-\frac{1}{2},j+1}^{n+\frac{1}{2}}
	\big),
\end{equation}
for $j=-1,\ldots,N+2, i=-\nu+1,\ldots,N+\nu$.

Thus, we obtain and similarly to the contravariant wind $u$ at C-grid points applying Equation \eqref{norm-contravariant-to-covariant}:
\begin{equation}
	\label{cova-2-contra-UU}
	u_{i+\frac{1}{2},j}^{n+\frac{1}{2}}	= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j}}}\bigg(
	U_{i+\frac{1}{2},j}^{n+\frac{1}{2}} - \cos{\alpha_{i+\frac{1}{2},j}}V_{i+\frac{1}{2},j}^{n+\frac{1}{2}}\bigg),
\end{equation}
for $i=-1,\ldots,N+2, j=-\nu+1,\ldots,N+\nu$, and similarly to the contravariant wind $v$ at D-grid points:
\begin{equation}
	\label{cova-2-contra-VV}
	v_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}	= \frac{1}{\sin^2{\alpha_{i,j+\frac{1}{2}}}}\bigg(
	V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}} - \cos{\alpha_{i,j+\frac{1}{2}}}U_{i,j+\frac{1}{2}}^{n+\frac{1}{2}}\bigg).
\end{equation}
for $j=-1,\ldots,N+2, i=-\nu+1,\ldots,N+\nu$.
Hence, we have the C-grid contravariant time-averaged winds that are needed for the flux operators.

For the kinetic energy fluxes, we require B-grid winds. 
For this reason, we compute the covariant B-grid wind using:
\begin{equation}
	\label{bgrid-U}
	U_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}	= 
	\frac{1}{2}\big(U_{i+\frac{1}{2},j+1}^{n+\frac{1}{2}} + U_{i+\frac{1}{2},j}^{n+\frac{1}{2}} \big),
\end{equation}
for $i=-1,\ldots,N+2, j=-\nu+1,\ldots,N+\nu$, and
\begin{equation}
	\label{bgrid-V}
	V_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}	= 
	\frac{1}{2}\big(V_{i,j+\frac{1}{2}}^{n+\frac{1}{2}} + V_{i+1,j+\frac{1}{2}}^{n+\frac{1}{2}} \big),
\end{equation}
and then we convert the winds from covariant to contravariant as
\begin{equation}
	\label{bgrid-UU}
	u_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}	= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j+\frac{1}{2}}}}\bigg(
	U_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}} - \cos{\alpha_{i+\frac{1}{2},j+\frac{1}{2}}}V_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}\bigg),
\end{equation}
for $i=-1,\ldots,N+2, j=-\nu+1,\ldots,N+\nu$, and similarly to the contravariant wind $v$ at D-grid points:
\begin{equation}
	\label{bgrid-VV}
	v_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}	= \frac{1}{\sin^2{\alpha_{i+\frac{1}{2},j+\frac{1}{2}}}}\bigg(
	V_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}} - \cos{\alpha_{i+\frac{1}{2},j+\frac{1}{2}}}U_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}\bigg).
\end{equation}

\subsubsection{Fluid depth}
The fluid depth is updated using the dimension-splitting method with PPM, as given by Equations \eqref{q-split}. 
This yields the values of $h_{ij}^{n+1}$ for $i,j=1, \ldots, N$.
Then, we may generate its ghost cell values using the duo-grid interpolation.

\subsubsection{Geopotential gradient}
Once we have computed $h^{n+1}_{ij}$, we are able to estimate the time-averaged geopotential on the A-grid as:
\begin{align}
	\label{2d-sw-eq-Dgrid-geo}
	\Phi^n_{ij} &= \Delta t{g(h^{n+1}_{ij} + b_{ij})},
\end{align}
for $i,j=-\nu+1, \ldots, N+\nu$.
Then, the  time-averaged geopotential on the B-grid (Equation \eqref{geop-bgrid}) may be using interpolation:
\begin{align}
	\Phi^n_{i+\frac{1}{2},j+\frac{1}{2}} = 
	\frac{\overline{\overline{\Phi^n_{i+\frac{1}{2},j+\frac{1}{2}}}^x}^y +  \overline{\overline{\Phi^n_{i+\frac{1}{2},j+\frac{1}{2}}}^y}^x}{2}.
\end{align}
Again, we use $h^{n+1}_{ij}$ instead of $h^{n}_{ij}$ so the D-grid scheme also becomes backward-forward in time, avoiding numerical instability.
Following that, we estimate the geopotential gradient on the D-grid and C-grid points, respectively, by using centered differences:
\begin{align}
	\label{2d-sw-eq-Dgrid-geo-dx}
	\delta_i \Phi^n_{i,j+\frac{1}{2}} &= 
	\Phi^{n}_{i+\frac{1}{2},j+\frac{1}{2}} - \Phi^{n+1}_{i-\frac{1}{2},j+\frac{1}{2}},
	\quad i=1,\ldots,N, j=0,\ldots,N,\\
	\label{2d-sw-eq-Dgrid-geo-dy}
	\delta_j \Phi^n_{i+\frac{1}{2},j} &=
	\Phi^{n}_{i+\frac{1}{2},j+\frac{1}{2}} - \Phi^{n}_{i+\frac{1}{2},j-\frac{1}{2}},
	\quad i=0,\ldots,N, j=1,\ldots,N.
\end{align}

\subsubsection{Absolute vorticity fluxes}
Using the D-grid covariant winds $(U_{i,j+\frac{1}{2}}^n,V_{i+\frac{1}{2},j}^n)$,
we may compute the relative vorticity (Equation \eqref{vort2-eq}) at the A-grid points using a centered finite difference:
\begin{align}
	\label{2d-sw-rv-Dgrid}
	\zeta_{ij}^n &= \frac{1}{\sqrt{\mathfrak{g}}_{ij}}\bigg[
	\frac{\mathfrak{V}_{i+\frac{1}{2},j}^n-\mathfrak{V}_{i-\frac{1}{2},j}^n}{\Delta x} -
	\frac{\mathfrak{U}_{i,j+\frac{1}{2}}^n-\mathfrak{U}_{i,j-\frac{1}{2}}^n}{\Delta y}
	\bigg]\nonumber\\
	&= 
	\frac{1}{|\hat{\Omega}_{ij}|}\bigg[
	{\big({\hat{\delta}y_{i+\frac{1}{2},j}{V}_{i+\frac{1}{2},j}^n-
		   \hat{\delta}y_{i-\frac{1}{2},j}{V}_{i-\frac{1}{2},j}^n}\big)} -
	{\big({\hat{\delta}x_{i,j+\frac{1}{2}}{U}_{i,j+\frac{1}{2}}^n-
		   \hat{\delta}x_{i,j-\frac{1}{2}}{U}_{i,j-\frac{1}{2}}^n}\big)}
	\bigg],
\end{align}
for $i,j=-\nu+1, \ldots, N+\nu$.
Then, we obtain the absolute vorticity on the A-grid as:
\begin{align}
	\label{2d-sw-av-Dgrid}
	\xi_{ij}^n =
	f_{ij} +
	\zeta_{ij}^n,
\end{align}
for $i,j=-\nu+1, \ldots, N+\nu$.
Using again that the relative vorticity is advected, we may use the PPM fluxes
$\mathcal{F}_{i+\frac{1}{2},j}^{PPM,x}, \mathcal{F}_{i,j+\frac{1}{2}}^{PPM,y}$
(Equations \eqref{ppmx-flux} and \eqref{ppmy-flux}) to compute the relative vorticity fluxes at the edges.
Then, its follows from Equation \eqref{q-split} that we need to compute the terms:
\begin{align}
	\label{absvort1}
	F_{i+\frac{1}{2},j}[\xi^{n}, u^n] &= 
	\frac{1}{2}
    \mathcal{A}_{i+\frac{1}{2},j}^{x} \bigg( \mathcal{F}_{i,j+\frac{1}{2}}^{PPM,x}[\xi^{n}, \tilde{c}^{x,n}]+
	\mathcal{F}_{i,j+\frac{1}{2}}^{PPM,x}[\xi^{n} + \mathbf{g}(\xi^{n},\tilde{c}^{y,n}), \tilde{c}^{x,n}] \bigg),\\
	\label{absvort2}
	G_{i,j+\frac{1}{2}}[\xi^{n}, v^n] &= 
	\frac{1}{2}
	\mathcal{A}_{i,j+\frac{1}{2}}^{y}\bigg( \mathcal{F}_{i,j+\frac{1}{2}}^{PPM,y}[\xi^{n}, \tilde{c}^{y,n}]+
	\mathcal{F}_{i,j+\frac{1}{2}}^{PPM,y}[\xi^{n} + \mathbf{f}(\xi^{n},\tilde{c}^{x,n}), \tilde{c}^{y,n}] \bigg),
\end{align}
where $\mathcal{A}_{i+\frac{1}{2},j}^{x}$ and $\mathcal{A}_{i,j+\frac{1}{2}}^{y}$ are given by Equations \eqref{ax-def} and \eqref{ay-def}, respectively.
The inner operators $\mathbf{f}$ and $\mathbf{g}$ are given in \eqref{chp-csfv-tab1}
and the terms $\tilde{c}^{x,n}$ and $\tilde{c}^{y,n}$ are the time-averaged CFL numbers described in Section \ref{sec-cfl}.
When using the duo-grid, these fluxes are computed twice. 
However, we do not employ flux averaging at the cube interfaces (Section \ref{flux-av}) as we achieved better results without it.

\subsubsection{Kinetic energy fluxes}
To estimate the integrals in Equation \eqref{ke-bgrid}, we assume again that:
\begin{equation}
	\label{eq_duu}
	{\partial_t U} + {\partial_x (uU)}(x, y_{j+\frac{1}{2}}, t) = 0,
\end{equation}
and a similar equation is assumed to hold for $v$ and $V$, and therefore the integrals 
of Equation \eqref{ke-bgrid} may estimated again using finite-volume fluxes.
In this case, we are going to consider the PPM fluxes
$\mathfrak{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{PPM,x}$ and $\mathfrak{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{PPM,y}$ (Equation \eqref{chp5-flux-xdir}), and
the kinetic energy on B-grid is given by:
\begin{equation}
	\label{ke-flux-bgrid}
	K_{i+\frac{1}{2},j+\frac{1}{2}}^n = \frac{\Delta t}{2}\bigg(
	\tilde{u}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}\mathfrak{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{PPM,x} [{{U}^n},\tilde{u}^{n}] +
	\tilde{v}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}\mathfrak{F}_{i+\frac{1}{2},j+\frac{1}{2}}^{PPM,y} [{{V}^n},\tilde{v}^{n}]\bigg),
\end{equation}
for $i,j=0,\ldots,N$.

The time-averaged B-grid winds $\tilde{u}^{n}$ and $\tilde{v}^{n}$ are computed using the DP1 scheme or the scheme DP2.
In this step, we use the B-grid contravariant winds 
${u}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}},{v}_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}$
obtained in Equations \eqref{bgrid-UU} and \eqref{bgrid-VV}.
If we use the DP2 scheme, we need ${u}_{i+\frac{1}{2},j+\frac{1}{2}}^{n},{v}_{i+\frac{1}{2},j+\frac{1}{2}}^{n}$,
which may obtained just as Equations \eqref{bgrid-UU} and \eqref{bgrid-VV}.
We also utilize the D-grid covariant winds obtained at time level $n$. 

Finally, on the cubed-sphere using the duo-grid, these PPM fluxes are computed twice. 
Therefore, we average them at the cube interfaces to obtain a unique value, as described in Section \ref{flux-av}.
Thus, we estimate the kinetic energy gradient using a centered difference:
\begin{align}
	\label{2d-sw-eq-Dgrid-ke-dx}
	\delta_i K^n_{i,j+\frac{1}{2}} &= K_{i+\frac{1}{2},j+\frac{1}{2}}^n - K_{i-\frac{1}{2},j+\frac{1}{2}}^n,
	\quad i=1,\ldots,N, j=0,\ldots,N,\\
	\label{2d-sw-eq-Dgrid-ke-dy}
	\delta_j K^n_{i+\frac{1}{2},j} &= K_{i+\frac{1}{2},j+\frac{1}{2}}^n - K_{i+\frac{1}{2},j-\frac{1}{2}}^n,
	\quad i=0,\ldots,N, j=1,\ldots,N.
\end{align}
Hence, we have completed the description of the D-grid wind update using Equations \eqref{2d-sweq-dscheme-u} and \eqref{2d-sweq-dscheme-v}.

\subsection{Divergence damping}
\label{dd-cs}
The divergence on B-grid points may be computed using the D-grid contravariant winds, using centered finite-differences as:
\begin{align*}
	\label{2d-sw-divdamp}
	D_{i+\frac{1}{2},j+\frac{1}{2}}[u^n,v^n] &=
	\frac{1}{\sqrt{\mathfrak{g}}_{i+\frac{1}{2},j+\frac{1}{2}}}\bigg[
	\frac{(\sqrt{\mathfrak{g}}\mathfrak{u})_{i+1,j+\frac{1}{2}}^n-(\sqrt{\mathfrak{g}}\mathfrak{u})_{i,j-\frac{1}{2}}^n}{\Delta x}+
	\frac{(\sqrt{\mathfrak{g}}\mathfrak{v})_{i+\frac{1}{2},j+1}^n-(\sqrt{\mathfrak{g}}\mathfrak{v})_{i+\frac{1}{2},j}^n}{\Delta y}
	\bigg]\nonumber\\
	&= 
	\frac{1}{|\hat{\Omega}_{i+\frac{1}{2},j+\frac{1}{2}}|}\bigg[
	{\hat{\delta}y_{i+1,j+\frac{1}{2}}{u}_{i+1,j+\frac{1}{2}}^n\sin{\alpha}_{i+1,j+\frac{1}{2}}-
	 \hat{\delta}y_{i  ,j+\frac{1}{2}}{u}_{i  ,j+\frac{1}{2}}^n\sin{\alpha}_{i  ,j+\frac{1}{2}}}\\
	&+{\hat{\delta}x_{i+\frac{1}{2},j+1}{v}_{i+\frac{1}{2},j+1}^n\sin{\alpha}_{i+\frac{1}{2},j+1}-
 	   \hat{\delta}x_{i+\frac{1}{2},j  }{v}_{i+\frac{1}{2},j  }^n\sin{\alpha}_{i+\frac{1}{2},j  }}
	\bigg].
\end{align*}
This is straightforward from the definition of divergence in terms of a cubed-sphere mapping (Equation \eqref{advcs:eqdiv}).
We may then compute the gradient of this divergence at D-grid wind positions, namely:
\begin{align}
	D^u_{i,j+\frac{1}{2}}[u^n,v^n] &= \frac{D_{i+\frac{1}{2},j+\frac{1}{2}}[u^n,v^n]- D_{i-\frac{1}{2},j+\frac{1}{2}}[u^n,v^n]}{\hat{\delta}x_{i,j+\frac{1}{2}}},
	\quad i=1,\ldots,N, j=0,\ldots,N,\\
	D^v_{i+\frac{1}{2},j}[u^n,v^n] &= \frac{D_{i+\frac{1}{2},j+\frac{1}{2}}[u^n,v^n]- D_{i+\frac{1}{2},j-\frac{1}{2}}[u^n,v^n]}{\hat{\delta}y_{i+\frac{1}{2},j}},
	\quad i=0,\ldots,N, j=1,\ldots,N.
\end{align}
Notice that we can apply the divergence operator $D_{i+\frac{1}{2},j+\frac{1}{2}}$
again to the inputs $D^u_{i,j+\frac{1}{2}}$ and $D^v_{i+\frac{1}{2},j}$.
and we may repeat this procedure as many times as we want.
This process results in divergence damping (dd) operator which is an explicit dissipation mechanism.
Dissipation mechanisms are commonly used in dynamical cores to ensure numerical stability and avoid accumulation of energy at the smallest grid scale.
There are many other ways of introducing dissipation besides divergence damping (see \citet{jablonowski:2011} for a review)
For an comprehensive analysis of the divergence damping operator, refer to \citet{whitehead:2011}. 

In FV3, the number of times we apply the divergence operator is denoted by \textit{nord} \citep{harris:2021}.
We are considering a divergence damping coefficient:
\begin{equation}
	\nu_D = (d_4 \min_{i,j} |\Omega_{ij}|)^{nord+1},
\end{equation}
where $d_4 \ge 0$  is a given constant.
The obtained results of after applying the divergence operator $nord$ times
are multiplied by $\nu_D$ and added in Equations \eqref{2d-sweq-dscheme-u} and \eqref{2d-sweq-dscheme-v}.

We point out that there are other numerical dissipation mechanisms available in FV3, such as vorticity damping and frictional heating \citep{harris:2021}. 
We are considering only the divergence damping for simplicity.
We also point out that limited scheme that we are using (hord8) has implicit diffusion.

\section{Proposed modifications}
\label{sw-modf}
As we have seen in Section \ref{csw-grid}, there are two options for using the upwind fluxes, 
which depend on the treatment of the metric term to be considered, namely, mt0 or mt1.
FV3 utilizes mt0. We are going to use the same option, and the C-grid solver is not modified.
This choice is made because no significant improvements were observed when using mt1.
Therefore, we are going to propose modifications only to the D-grid scheme.

Notice that, for the D-grid solver, the kinetic energy flux computed in Equation \eqref{ke-flux-bgrid} using PPM may be computed using DP1 or DP2. 
Also, observe that this term does not have the metric term $\sqrt{\mathfrak{g}}$ to be considered.
However, we find that using DP2 does not improve the results; actually, they get worse.
We believe that the DP2 scheme does not improve the kinetic energy flux because the advection hypotheses 
assumed by FV3 for the wind components (Equation \eqref{eq_duu}) are not true.
Therefore, improving the advection flux in this step does not necessarily improve the kinetic energy flux computation.
Thus, we are going to use the DP1 scheme for the kinetic energy flux (Equation \eqref{ke-flux-bgrid}).

There are two parts of the D-grid scheme where we may use the LT advection scheme from Chapter \ref{chp-cs-fv}:
the fluid depth update and the vorticity fluxes (Equations \eqref{absvort1} and \eqref{absvort2}).
Currently, these parts are solved using the PL advection scheme, and we propose assessing the impact of using the LT advection scheme
only for the continuity equation for simplicity.
The shallow-water solver that uses PL for these fluxes is referred to simply as the PL scheme, and when LT is used, we refer to it as the LT scheme.

\section{Numerical experiments}
\label{sec:numerical_results}
In this Section, we are going to compare the PL and LT shallow-water schemes described \eqref{sw-modf} using classical
shallow-water tests presented in the literature.
These schemes shall be tested with the hord8 scheme.

The D-grid output $(U_{i,j+\frac{1}{2}}^n,V_{i+\frac{1}{2},j}^n)$ is interpolated to the A-grid as
\begin{align}
U_{ij}^n &= \frac{(U_{i,j+\frac{1}{2}}^n+U_{i,j-\frac{1}{2}}^n)}{2},\\
V_{ij}^n &= \frac{(V_{i+\frac{1}{2},j}^n+V_{i-\frac{1}{2},j}^n)}{2},
\end{align}
and then converted to latitude-longitude winds using Equations \eqref{norm-contravariant-to-covariant} and \eqref{ll-to-normcontravariant},
where we obtain $(u_{\lambda})_{ij}^n,(v_{\phi})_{ij}^n$ on the A-grid.
This facilitates plotting and reference solution calculation. 
We point out that this does not impact the error check, 
provided our schemes are at best-case second-order, 
as this averaging is second-order accurate and the wind conversion is an exact transformation.

%Then, the errors are computed using a reference solution on the A-grid, denoted by $(h^{REF})^n$, $(u_{\lambda}^{REF})^n$ and $(v_{\phi}^{REF})^n$. 
%The reference solution shall be assumed to be computed exactly or we follow the approach of \citet{peixoto:2016} and use
%the ENDGame (Even Newer Dynamics for General atmospheric modelling of the environment) shallow-water solver developed by \citet{thuburn:2010},
%which is the current UK MetOffice operational dynamical core 
%(\url{https://www.metoffice.gov.uk/research/foundation/dynamics/endgame}, last accessed on April 3rd, 2024).
%This model is semi-Lagrangian and semi-implicit on a latitude-longitude grid.
%As suggested by \citet{peixoto:2016}, we use a grid size of 2048$\times$1024 with a time step of 50 seconds whenever we employ it.
%This grid has a 20km resolution at the equator.
%The outputs of ENDGame are interpolated to the cubed-sphere A-grid from the latitude-longitude grid using cubic interpolation,
%giving us the reference solutions $(h^{REF})^n$, $(u_{\lambda}^{REF})^n$, and $(v_{\phi}^{REF})^n$.

We will consider the global steady geostrophic flow test case from \citet{will:1992}.
This test initializes the depth using Equation \eqref{duo-tc1} (Figure \ref{cs-duo-tc1}) and the winds using Equation \eqref{duo-wind1}.
We set $\alpha=\frac{\pi}{4}$ so that the flow is oriented with the corners of a cube.
In this setup, the Coriolis parameter (Equation \eqref{coriolis-eq2}) is modified as
\begin{equation}
	\label{coriolis-eq2}
	f = 2 \Omega(-\cos{\phi}\cos{\lambda}\sin{\alpha} + \sin{\phi}\cos{\alpha}),
\end{equation}
and therefore, the initial condition does not change over time, allowing us to compute the exact solution.
%All the test cases (TCs) that we are going to consider are presented in Table \ref{sw-tc}.

To compute the error convergence, we consider cubed-sphere grids with values of
$N_k = 48\times2^{k}$, and \textit{dt\textunderscore atmos}$^{(k)} = \frac{dt\textunderscore atmos^{(0)}}{2^k}$ for 
$k=0, \ldots, 4$, where the value of \textit{dt\textunderscore atmos}$^{(0)}$ is taken from Table \ref{chp5-vf}. %for each TC.
The value of n\_split is the same regardless of the value of $N_k$.
We are going to consider both the g0 and g2 grids with the spherical midpoint formulation.%, and it will always be made clear whether the divergence damping is being used or not (Section \ref{dd-cs}).%Whenever we use divergence damping, we consider $d_4 = 0.12$ and $nord=2$, as used in \citet{mouallem:2023}.
We also use divergence damping, we consider $d_4 = 0.12$ and $nord=2$, as used in \citet{mouallem:2023}.
In this case, the dissipation is a fourth-order operator and therefore is more scale selective.
\begin{table}[!ht]
	\begin{tabular}{|l|l|l|l|l|l|}
		\hline
		Test case & Description            & Reference & \textit{dt\textunderscore atmos$^{(0)}$} & n\_split & Total time \\ \hline
		TC2       & Geostrophic balance    & \citet{will:1992}       & 3600 \textit{s}               & 7     & 5 \textit{days}   \\ \hline
		%TC5       & Flow over a mountain   & \citet{will:1992}        & 1800 \textit{s}               & 7    & 15 \textit{days}  \\ \hline
		%TC7       & Barotropic instability & \citet{galewsky:2004}      & 1800 \textit{s}             & 8  & 7 \textit{days}    \\ \hline
	\end{tabular}
	\caption{The test case considered in the numerical experiments, including descriptions, references, 
		initial atmospheric time step \textit{dt\textunderscore atmos}$^{(0)}$, 
	    the number of times that the horizontal dynamics are solved on each atmospheric time step (n\_split)
	    and the total time of integration.}
\label{sw-tc}
\end{table}



\begin{figure}[!h]
	\centering
	\begin{subfigure}{0.6\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{h_error_tc2_t5_alpha45_C192_g0_dg1_adv1_hord8_dd0.12_mf1_tf5}
		\caption{PL scheme, max= $7.03\times10^{-2}$.\label{chp-advcs-sec-exp-sw1-errors-0a}}
	\end{subfigure}
	\begin{subfigure}{0.6\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{h_error_tc2_t5_alpha45_C192_g0_dg1_adv2_hord8_dd0.12_mf1_tf5}
		\caption{ max= $5.37\times10^{-2}$.\label{chp-advcs-sec-exp-sw1-errors-0b}}
	\end{subfigure}
	\caption{
		Geostrophic flow test using hord8
		with PL (top) and LT schemes (bottm) on the g0 grid with $N=192$. 
		\label{chp-advcs-sec-exp-sw1-errors-0}}
\end{figure}
\newpage
\begin{figure}[!h]
	\centering
	\begin{subfigure}{0.6\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{h_error_tc2_t5_alpha45_C192_g2_dg1_adv1_hord8_dd0.12_mf1_tf5}
		\caption{PL scheme,  max= $6.27\times10^{-2}$.\label{chp-advcs-sec-exp-sw1-errors-2a}}
	\end{subfigure}
	\begin{subfigure}{0.6\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{h_error_tc2_t5_alpha45_C192_g2_dg1_adv2_hord8_dd0.12_mf1_tf5}
		\caption{LT scheme, max= $5.49\times10^{-2}$.\label{chp-advcs-sec-exp-sw1-errors-2b}}
	\end{subfigure}
	\caption{As Figure \ref{chp-advcs-sec-exp-sw1-errors-0} but using the g2 grid.\label{chp-advcs-sec-exp-sw1-errors-2}}
\end{figure}

rom Figure \ref{chp-advcs-sec-exp-sw1-errors-0}, we observe the errors for the grid g0 using the PL and LT schemes. It is evident that the LT scheme has a smaller error. Furthermore, although both schemes exhibit grid imprinting, the PL scheme displays more pronounced grid imprinting, whereas the LT scheme shows a more evenly distributed error.
For the g2 grid, LT reduces the maximum error, but the grid imprinting is very similar to the PL scheme.
This test case demonstrates how the LT scheme improves performance for the g0 and g2 grids.

Finally, Figure \ref{chp-advcs-sec-exp-sw-l2} shows the error convergence for the zonal wind in the $L_{\infty}$. 
We can notice that the error of LT is slightly smaller and both schemes achieve 2nd order.
\newpage
\begin{figure}[!htb]
	\centering
	\includegraphics[width=0.8\linewidth]{u_linferror_tc2_alpha45}
	\caption{Error of the zonal wind component for the geostrophic case for the g0 (left) and g2 (right) grids \label{chp-advcs-sec-exp-sw-l2}}
\end{figure}

%\subsection{Global steady geostrophic flow - to be written}

%\subsection{Flow over a mountain}
%\subsection{Barotropically unstable jet with perturbation}
%\section{Conclusions - to be written}
%\label{sec:conclusions}